<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- iOS Web App 图标配置 -->
    <link rel="apple-touch-icon" href="./VocabMaster_logo.jpeg">
    <!-- 标准浏览器图标配置 -->
    <link rel="icon" href="./VocabMaster_logo.jpeg" type="image/jpeg">
    <link rel="shortcut icon" href="./VocabMaster_logo.jpeg" type="image/jpeg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="VocabMaster">
    <title>VocabMaster - Word Learning & Testing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36D399',
                        danger: '#F87272',
                        neutral: '#F3F4F6',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .transition-custom {
                transition: all 0.3s ease;
            }
            .option-hover {
                @apply hover:bg-primary/5 transition-all duration-200 cursor-pointer;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-custom;
            }
            .btn-danger {
                @apply bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg transition-custom;
            }
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded-lg transition-custom;
            }
            .btn-gray {
                @apply bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-custom;
            }
        }
    </style>
    
    <!-- 简化版句子导入功能 -->
    <!-- <script src="./simple-import.js"></script> -->
    <!-- 直接API测试脚本 -->
    <!-- <script src="./direct-api-test.js"></script> -->
    
    <script>
        // API 基础URL - 使用相对路径
        const API_BASE_URL = '/api';
    </script>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <!-- Top Navigation -->
    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-book text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">VocabMaster</h1>
            </div>
            
            <nav class="hidden md:flex space-x-6">
                <button id="nav-import" class="nav-btn active py-2 font-medium text-primary border-b-2 border-primary">
                    <i class="fa fa-upload mr-1"></i> Import
                </button>
                <button id="nav-manage" class="nav-btn py-2 font-medium text-gray-600 hover:text-primary transition-custom">
                    <i class="fa fa-list mr-1"></i> Manage
                </button>
                <button id="nav-test" class="nav-btn py-2 font-medium text-gray-600 hover:text-primary transition-custom">
                    <i class="fa fa-check-square-o mr-1"></i> Test
                </button>
                <button id="nav-mistakes" class="nav-btn py-2 font-medium text-gray-600 hover:text-primary transition-custom">
                    <i class="fa fa-exclamation-triangle mr-1"></i> Mistakes
                </button>
                <button id="nav-results" class="nav-btn py-2 font-medium text-gray-600 hover:text-primary transition-custom">
                    <i class="fa fa-bar-chart mr-1"></i> Results
                </button>
            </nav>
            
            <button id="mobile-menu-btn" class="md:hidden text-gray-600 focus:outline-none">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <div class="container mx-auto px-4 py-2 flex flex-col space-y-3">
                <button id="mobile-import" class="mobile-nav-btn active py-2 font-medium text-left text-primary">
                    <i class="fa fa-upload mr-2"></i> Import Words
                </button>
                <button id="mobile-manage" class="mobile-nav-btn py-2 font-medium text-left text-gray-600">
                    <i class="fa fa-list mr-2"></i> Manage Words
                </button>
                <button id="mobile-test" class="mobile-nav-btn py-2 font-medium text-left text-gray-600">
                    <i class="fa fa-check-square-o mr-2"></i> Take Test
                </button>
                <button id="mobile-mistakes" class="mobile-nav-btn py-2 font-medium text-left text-gray-600">
                    <i class="fa fa-exclamation-triangle mr-2"></i> Mistake Words
                </button>
                <button id="mobile-results" class="mobile-nav-btn py-2 font-medium text-left text-gray-600">
                    <i class="fa fa-bar-chart mr-2"></i> Test Results
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pt-24 pb-16 min-h-screen">
        <!-- Import Words Module -->
        <section id="setting-section" class="section hidden">
            <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                    <i class="fa fa-cog text-primary mr-3"></i> Settings
                </h2>
                
                <div class="space-y-8">
                    <!-- AI Reading Generation Settings -->
                    <div class="bg-neutral p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">AI Reading Generation Settings</h3>
                        
                        <div class="space-y-6">
                            <!-- Difficulty Level -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Reading Difficulty Level</label>
                                <div class="grid grid-cols-1 gap-3">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="reading-difficulty" value="beginner" class="text-primary focus:ring-primary" checked>
                                        <span class="ml-2 text-gray-700">Beginner (初级)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="reading-difficulty" value="intermediate" class="text-primary focus:ring-primary">
                                        <span class="ml-2 text-gray-700">Intermediate (中级)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="reading-difficulty" value="advanced" class="text-primary focus:ring-primary">
                                        <span class="ml-2 text-gray-700">Advanced (高级)</span>
                                    </label>
                                </div>
                            </div>
                            

                            
                            <!-- Custom Parameters -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Article Word Count (AA) -->
                                <div>
                                    <label for="article-word-count" class="block text-sm font-medium text-gray-700 mb-2">Article Word Count (AA)</label>
                                    <input 
                                        type="number" 
                                        id="article-word-count" 
                                        min="50" 
                                        max="500" 
                                        value="100" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                                    >
                                    <p class="mt-1 text-xs text-gray-500">Default: 100 words</p>
                                </div>
                                
                                <!-- New Words Percentage (BB) -->
                                <div>
                                    <label for="new-words-percentage" class="block text-sm font-medium text-gray-700 mb-2">New Words Percentage (BB)</label>
                                    <input 
                                        type="number" 
                                        id="new-words-percentage" 
                                        min="0" 
                                        max="100" 
                                        value="0" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                                    >
                                    <p class="mt-1 text-xs text-gray-500">Default: 0%</p>
                                </div>
                                
                                <!-- Number of Questions (CC) -->
                                <div>
                                    <label for="number-of-questions" class="block text-sm font-medium text-gray-700 mb-2">Number of Questions (CC)</label>
                                    <input 
                                        type="number" 
                                        id="number-of-questions" 
                                        min="1" 
                                        max="10" 
                                        value="3" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                                    >
                                    <p class="mt-1 text-xs text-gray-500">Default: 3 questions</p>
                                </div>
                                
                                <!-- Number of Options (DD) -->
                                <div>
                                    <label for="number-of-options" class="block text-sm font-medium text-gray-700 mb-2">Number of Options (DD)</label>
                                    <input 
                                        type="number" 
                                        id="number-of-options" 
                                        min="2" 
                                        max="5" 
                                        value="3" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                                    >
                                    <p class="mt-1 text-xs text-gray-500">Default: 3 options</p>
                                </div>
                            </div>
                            
                            <!-- Custom Prompt -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Custom Prompt (自定义提示词)</label>
                                <textarea 
                                    id="custom-prompt"
                                    rows="4"
                                    placeholder="输入自定义提示词来指导AI生成特定内容的阅读材料。例如：请生成一篇关于环保的英语短文，适合初级学习者阅读。"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                                ></textarea>
                                <p class="mt-1 text-xs text-gray-500">留空则使用系统默认提示词</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Settings Button -->
                    <div class="flex justify-end">
                        <button id="save-settings-btn" class="btn-primary">
                            <i class="fa fa-save mr-1"></i> Save Settings
                        </button>
                    </div>
                </div>

                <!-- English Translation Test View -->
                <div id="translation-test-view" class="hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">English Translation Test</h2>
                            <div class="text-sm text-gray-500">
                                Question <span id="translation-current-question">1</span> of <span id="translation-total-questions">3</span>
                            </div>
                        </div>

                        <!-- English Sentence Display -->
                        <div class="p-6 bg-gray-50 rounded-xl mb-6 border border-gray-200">
                            <p id="translation-english-sentence" class="text-xl font-medium text-gray-800 leading-relaxed">
                                Lily usually helps mom cook at six p.m.
                            </p>
                        </div>

                        <!-- Answer Area -->
                        <div class="mb-8">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Answer</label>
                            <div id="translation-answer-area" class="min-h-[60px] p-4 bg-white rounded-lg border-2 border-dashed border-gray-300 flex flex-wrap items-center gap-2">
                                <!-- Selected words will be displayed here -->
                            </div>
                        </div>

                        <!-- Word Selection Area -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Words</label>
                            <div id="translation-word-options" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                                <!-- Word options will be dynamically inserted here -->
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-between">
                            <button id="translation-clear-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-custom">
                                Clear Selection
                            </button>
                            <button id="translation-submit-btn" class="btn-primary">
                                Submit Answer
                            </button>
                        </div>
                    </div>

                    <!-- Translation Result Feedback -->
                    <div id="translation-result-feedback" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6 hidden">
                        <div id="translation-result-content" class="text-center py-4">
                            <!-- Result content will be inserted here -->
                        </div>
                        <div class="flex justify-center">
                            <button id="translation-next-btn" class="btn-primary">
                                Next Question
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="import-section" class="section active">
            <div class="max-w-3xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fa fa-upload text-primary mr-3"></i> Import Words
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- Text Area Import -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Enter words (one per line, format: English word,Chinese meaning,Example sentence)
                            </label>
                            <textarea 
                                id="words-textarea" 
                                rows="8" 
                                placeholder="example,例子,This is an example sentence.\nsample,样本,Can I see a sample first?\n..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            ></textarea>
                            <button id="import-text-btn" class="mt-3 btn-primary">
                                <i class="fa fa-check mr-1"></i> Import Text
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reading Comprehension Import Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <span class="flex items-center mb-3 md:mb-0">
                                <i class="fa fa-book text-primary mr-3"></i> Import Reading Comprehension
                            </span>
                            <div class="flex gap-3">
                                <button id="reading-setting-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-custom flex items-center justify-center">
                                    <i class="fa fa-cog mr-2"></i> Settings
                                </button>
                                <button id="ai-generate-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-custom flex items-center justify-center">
                                    <i class="fa fa-magic mr-2"></i> AI Generating
                                </button>
                            </div>
                        </div>
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- 阅读文本框 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                阅读文本
                            </label>
                            <textarea 
                                id="passage-textarea" 
                                rows="6" 
                                placeholder="My Weekend at Grandma's
Last Saturday, I went to stay with my grandma. In the morning, we walked to her garden..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            ></textarea>
                            <p class="mt-1 text-xs text-gray-500">第一行为标题，后续为正文内容</p>
                        </div>
                         
                        <!-- 选择题框 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                选择题
                            </label>
                            <textarea 
                                id="questions-textarea" 
                                rows="6" 
                                placeholder="1. Where did the writer and grandma go in the morning?
A. The park
B. The garden
C. The supermarket
2. What color is the rabbit they saw in the park?
A. Brown
B. White
C. Green"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            ></textarea>
                            <p class="mt-1 text-xs text-gray-500">每个题目以数字开头，选项A、B、C分行列出</p>
                        </div>
                         
                        <!-- 答案框 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                答案
                            </label>
                            <textarea 
                                id="answers-textarea" 
                                rows="4" 
                                placeholder="1. B
2. B"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            ></textarea>
                            <p class="mt-1 text-xs text-gray-500">每行一个答案，格式为"题号. 答案选项"</p>
                        </div>
                         
                        <div class="flex justify-center">
                            <button id="import-reading-btn" class="btn-primary">
                                <i class="fa fa-check mr-1"></i> Import Reading
                            </button>
                        </div>
                    </div>
                </div>

                <!-- English Sentence Translation Import Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fa fa-language text-primary mr-3"></i> Import English Sentence Translation
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- Sentence Text Area -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                输入英文语句及对应的中文分词
                            </label>
                            <textarea 
                                id="sentences-textarea" 
                                rows="8" 
                                placeholder="Lily usually helps mom cook at six p.m.
莉莉，通常，下午六点，帮，妈妈，做饭。

1. I go to school by bus every day.
我，每天，乘公交车，去上学。" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            ></textarea>
                            <p class="mt-1 text-xs text-gray-500">英文语句可以带编号或不带编号，中文分词用逗号或顿号分隔</p>
                            <button id="import-sentences-btn" class="mt-3 btn-primary">
                                <i class="fa fa-check mr-1"></i> Import Sentences
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Import Results -->
                <div id="import-results" class="bg-white rounded-xl shadow-lg p-6 md:p-8 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                        <i class="fa fa-check-circle text-primary mr-2"></i> 导入结果
                    </h3>
                    
                    <div id="import-success" class="mb-4 hidden">
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fa fa-check-circle text-green-500 mt-0.5"></i>
                                </div>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-green-800">Import Successful</h4>
                                    <div class="mt-2 text-sm text-green-700">
                                        <p><span id="imported-count">0</span> words imported successfully</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Duplicate Words Warning -->
                    <div id="import-duplicates" class="mb-4 hidden">
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fa fa-exclamation-triangle text-yellow-500 mt-0.5"></i>
                                </div>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-yellow-800">Duplicate Words Found</h4>
                                    <div class="mt-2 text-sm text-yellow-700">
                                        <p>The following words already exist. Choose whether to update:</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="duplicates-list" class="space-y-3 mb-4"></div>
                        
                        <div class="flex justify-end space-x-3">
                            <button id="skip-duplicates-btn" class="btn-gray">
                                跳过
                            </button>
                            <button id="update-duplicates-btn" class="btn-primary">
                                更新
                            </button>
                        </div>
                    </div>
                    
                    <div id="import-errors" class="hidden">
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fa fa-exclamation-circle text-red-500 mt-0.5"></i>
                                </div>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-red-800">Import Errors</h4>
                                    <div class="mt-2 text-sm text-red-700">
                                        <p><span id="errors-count">0</span> words failed to import</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="errors-list" class="text-sm text-gray-600 space-y-2 max-h-60 overflow-auto"></div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button id="close-import-results" class="btn-gray">
                            Close
                        </button>
                        <button id="go-to-manage-btn" class="btn-primary">
                            <i class="fa fa-list mr-1"></i> Manage Words
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Word Management Module -->
        <section id="manage-section" class="section hidden">
            <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fa fa-list text-primary mr-3"></i> Manage Vocabulary
                    </h2>
                    
                    <div class="mt-4 md:mt-0 flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <input 
                                id="search-words" 
                                type="text" 
                                placeholder="Search words..." 
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom w-full sm:w-64"
                            >
                            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button id="add-word-btn" class="btn-secondary">
                            <i class="fa fa-plus mr-1"></i> Add Word
                        </button>
                        <button id="export-words-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-custom disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-download mr-1"></i> Export
                        </button>
                        <button id="clear-words-btn" class="btn-danger disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-trash mr-1"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <div id="no-words-message" class="hidden py-16 text-center">
                    <i class="fa fa-book text-5xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">No words available</p>
                        <p class="text-gray-400 mt-2">Import or add words to start learning</p>
                    <button id="go-to-import-btn" class="mt-4 btn-primary">
                            <i class="fa fa-upload mr-1"></i> Import Words
                        </button>
                </div>
                
                <div id="words-container" class="overflow-auto max-h-[60vh] rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                                    <input type="checkbox" id="select-all-words" class="text-primary focus:ring-primary rounded">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">English</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24 whitespace-normal min-w-[96px] max-w-[96px]">Chinese</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Example</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Added Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="words-list" class="bg-white divide-y divide-gray-200">
                            <!-- 单词列表将在这里动态添加 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 flex justify-between items-center">
                    <p class="text-sm text-gray-600">
                        Total <span id="total-words">0</span> words
                    </p>
                    <button id="delete-selected-btn" class="btn-danger disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-trash mr-1"></i> Delete Selected
                    </button>
                </div>
            </div>
            
            <!-- Sentence Management Module -->
            <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fa fa-align-left text-primary mr-3"></i> Manage Sentences
                    </h2>
                    
                    <div class="mt-4 md:mt-0 flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <input 
                                id="search-sentences" 
                                type="text" 
                                placeholder="Search sentences..." 
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom w-full sm:w-64"
                            >
                            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button id="add-sentence-btn" class="btn-secondary">
                            <i class="fa fa-plus mr-1"></i> Add Sentence
                        </button>
                        <button id="export-sentences-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-custom disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-download mr-1"></i> Export
                        </button>
                        <button id="clear-sentences-btn" class="btn-danger disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-trash mr-1"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <div id="no-sentences-message" class="hidden py-16 text-center">
                    <i class="fa fa-align-left text-5xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">No sentences available</p>
                    <p class="text-gray-400 mt-2">Import or add sentences to start practicing</p>
                    <button id="go-to-import-sentences-btn" class="mt-4 btn-primary">
                        <i class="fa fa-upload mr-1"></i> Import Sentences
                    </button>
                </div>
                
                <div id="sentences-container" class="overflow-auto max-h-[60vh] rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                                    <input type="checkbox" id="select-all-sentences" class="text-primary focus:ring-primary rounded">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">English Sentence</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chinese Answers</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Added Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sentences-list" class="bg-white divide-y divide-gray-200">
                            <!-- 句子列表将在这里动态添加 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 flex justify-between items-center">
                    <p class="text-sm text-gray-600">
                        Total <span id="total-sentences">0</span> sentences
                    </p>
                    <button id="delete-selected-sentences-btn" class="btn-danger disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-trash mr-1"></i> Delete Selected
                    </button>
                </div>
            </div>
        </section>

        <!-- 测试模块 -->
        <section id="test-section" class="section hidden">
            <div class="max-w-2xl mx-auto">
                <!-- 测试设置 -->
                <div id="test-settings" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fa fa-cog text-primary mr-3"></i> 测试设置
                    </h2>
                    
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Test Type</label>
                            <div class="grid grid-cols-1 gap-3">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="test-type" value="english-to-chinese-multiple" class="text-primary focus:ring-primary" checked>
                                    <span class="ml-2 text-gray-700">English → Chinese (Multiple Choice)</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="test-type" value="chinese-to-english-multiple" class="text-primary focus:ring-primary">
                                    <span class="ml-2 text-gray-700">Chinese → English (Multiple Choice)</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="test-type" value="sentence-filling-multiple" class="text-primary focus:ring-primary">
                                    <span class="ml-2 text-gray-700">Sentence Filling (Multiple Choice)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label for="test-count" class="block text-sm font-medium text-gray-700 mb-1">Number of Test Words</label>
                            <div class="flex items-center">
                                <input 
                                    type="number" 
                                    id="test-count" 
                                    min="1" 
                                    max="100" 
                                    value="40" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                                >
                                <span class="ml-3 text-gray-500 text-sm" id="max-words-text">最大: 0</span>
                            </div>
                        </div>
                        
                        <button id="start-test-btn" class="w-full btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-play mr-2"></i> Start Test
                        </button>
                    </div>
                </div>

                <!-- Reading Comprehension Section -->
                <div id="reading-comprehension-box" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fa fa-book text-primary mr-3"></i> Reading Comprehension
                    </h2>
                    
                    <div class="space-y-5">
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-gray-700">Take a reading comprehension test to improve your reading skills and vocabulary understanding.</p>
                        </div>
                        
                        <button id="start-reading-test-btn" class="w-full btn-primary">
                            <i class="fa fa-book mr-2"></i> Start Test
                        </button>
                    </div>
                </div>

                <!-- English Translation Test Section -->
                <div id="english-translation-box" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fa fa-language text-primary mr-3"></i> English Translation
                    </h2>
                    
                    <div class="space-y-5">
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-gray-700">Translate English sentences into Chinese by selecting the correct word sequence.</p>
                        </div>
                        
                        <div>
                            <label for="translation-test-count" class="block text-sm font-medium text-gray-700 mb-1">Number of Test Sentences</label>
                            <input 
                                type="number" 
                                id="translation-test-count" 
                                min="1" 
                                max="20" 
                                value="3" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            >
                        </div>
                        
                        <button id="start-translation-test-btn" class="w-full btn-primary">
                            <i class="fa fa-play mr-2"></i> Start Test
                        </button>
                    </div>
                </div>
                
                <!-- Test in Progress -->
                <div id="test-in-progress" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i class="fa fa-check-square-o text-primary mr-3"></i> Taking Test
                        </h2>
                        <div class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">
                            <span id="current-question">1</span>/<span id="total-questions">40</span>
                        </div>
                    </div>
                    
                    <!-- 选择题测试 -->
                    <div id="multiple-choice-container" class="mb-8">
                        <p class="text-gray-500 text-sm mb-2">Question</p>
                        <div class="bg-neutral p-6 rounded-lg mb-4">
                            <p id="mc-question" class="text-xl font-medium text-gray-800"></p>
                            <button id="show-example-btn" class="mt-3 text-sm text-primary hover:text-primary/80 transition-custom">
                                <i class="fa fa-book mr-1"></i> Show Example
                            </button>
                            <div id="example-container" class="mt-3 p-3 bg-gray-100 rounded-lg hidden">
                                <p id="word-example" class="text-gray-700"></p>
                            </div>
                        </div>
                        
                        <p class="text-gray-500 text-sm mb-2">Select the correct answer</p>
                        <div id="options-container" class="space-y-3">
                            <!-- 选项将在这里动态添加 -->
                        </div>
                    </div>
                    
                    <!-- Answer Feedback -->
                    <div id="answer-feedback" class="mt-6 p-4 rounded-lg hidden">
                        <div class="flex items-start">
                            <i id="feedback-icon" class="text-xl mt-0.5 mr-3"></i>
                            <div>
                                <h4 id="feedback-title" class="font-medium"></h4>
                                <p id="feedback-message" class="mt-1 text-gray-600"></p>
                            </div>
                        </div>
                        <button id="next-question-btn" class="mt-4 bg-primary/10 hover:bg-primary/20 text-primary font-medium py-2 px-4 rounded-lg transition-custom">
                            Next Question
                        </button>
                    </div>
                </div>
                
                <!-- English Translation Test View -->
                <div id="translation-test-view" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i class="fa fa-language text-primary mr-3"></i> English Translation Test
                        </h2>
                        <div class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">
                            <span id="translation-current-question">1</span>/<span id="translation-total-questions">0</span>
                        </div>
                    </div>
                    
                    <!-- English Sentence Display -->
                    <div class="bg-neutral p-6 rounded-lg mb-6">
                        <p id="translation-english-sentence" class="text-xl font-medium text-gray-800"></p>
                    </div>
                    
                    <!-- Answer Area -->
                    <div class="mb-6">
                        <p class="text-gray-500 text-sm mb-2">Your Translation</p>
                        <div id="translation-answer-area" class="min-h-12 p-4 bg-blue-50 border border-blue-100 rounded-lg flex flex-wrap gap-2">
                            <!-- Selected words will be displayed here -->
                        </div>
                    </div>
                    
                    <!-- Word Options -->
                    <div class="mb-6">
                        <p class="text-gray-500 text-sm mb-2">Select Chinese Words</p>
                        <div id="translation-word-options" class="flex flex-wrap gap-2">
                            <!-- Word options will be dynamically added here -->
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex justify-between">
                        <button id="translation-clear-btn" class="btn-gray">
                            <i class="fa fa-eraser mr-1"></i> Clear Selection
                        </button>
                        <button id="translation-submit-btn" class="btn-primary">
                            <i class="fa fa-check mr-1"></i> Submit Answer
                        </button>
                    </div>
                    
                    <!-- Result Feedback -->
                    <div id="translation-result-feedback" class="mt-6 p-4 rounded-lg hidden">
                        <div id="translation-result-content" class="text-center py-4">
                            <!-- Result content will be inserted here -->
                        </div>
                        <div class="flex justify-center">
                            <button id="translation-next-btn" class="btn-primary">
                                Next Question
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Test Results -->
                <div id="test-results" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6 hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fa fa-check-circle text-primary mr-3"></i> Test Results
                    </h2>
                    
                    <div class="flex flex-col md:flex-row items-center justify-between mb-8">
                        <div class="text-center md:text-left mb-6 md:mb-0">
                            <p class="text-gray-500">Your Score</p>
                            <div class="text-5xl font-bold text-primary mt-1" id="test-score">0%</div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-6 w-full md:w-auto">
                            <div class="text-center">
                                <p class="text-gray-500 text-sm">Total Questions</p>
                                <p class="text-xl font-bold text-gray-800 mt-1" id="result-total">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-500 text-sm">Correct</p>
                                <p class="text-xl font-bold text-secondary mt-1" id="result-correct">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-500 text-sm">Incorrect</p>
                                <p class="text-xl font-bold text-danger mt-1" id="result-incorrect">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Detailed Results</h3>
                        
                        <div id="detailed-results" class="space-y-4 max-h-[40vh] overflow-auto">
                            <!-- 详细结果将在这里动态添加 -->
                        </div>
                    </div>
                    
                    <div class="mt-8 flex flex-col sm:flex-row justify-between gap-3">
                        <button id="restart-test-btn" class="btn-primary">
                            <i class="fa fa-refresh mr-1"></i> Test Again
                        </button>
                        <button id="review-mistakes-btn" class="btn-danger disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-exclamation-triangle mr-1"></i> Review Mistakes
                        </button>
                        <button id="save-results-btn" class="btn-secondary">
                            <i class="fa fa-save mr-1"></i> Save Results
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Mistakes Module -->
        <section id="mistakes-section" class="section hidden">
            <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fa fa-exclamation-triangle text-danger mr-3"></i> Manage Mistakes
                    </h2>
                    
                    <div class="mt-4 md:mt-0 flex flex-col sm:flex-row gap-3">
                        <div class="relative">
                            <input 
                                id="search-mistakes" 
                                type="text" 
                                placeholder="Search mistakes..." 
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom w-full sm:w-64"
                            >
                            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button id="clear-mistakes-btn" class="btn-danger disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-trash mr-1"></i> Clear Mistakes
                        </button>
                    </div>
                </div>
                
                <div id="no-mistakes-message" class="hidden py-16 text-center">
                    <i class="fa fa-check-circle text-5xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">No mistakes available</p>
                        <p class="text-gray-400 mt-2">Keep up the good work, avoid mistakes!</p>
                </div>
                
                <div id="mistakes-container" class="overflow-auto max-h-[60vh] rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">English</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chinese</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Example</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mistake Count</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correct Streak</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mistakes-list" class="bg-white divide-y divide-gray-200">
                            <!-- 错词列表将在这里动态添加 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 flex justify-between items-center">
                    <p class="text-sm text-gray-600">
                        Total <span id="mistakes-count">0</span> mistakes
                    </p>
                    <button id="test-mistakes-btn" class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-check-square-o mr-1"></i> Test Mistakes
                    </button>
                </div>
            </div>
        </section>

        <!-- Reading Comprehension Module -->
        <section id="reading-section" class="section hidden">
            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                    <i class="fa fa-book text-primary mr-3"></i> Reading Comprehension
                </h2>

                <!-- Reading Passage List -->
                <div id="passage-list" class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Available Passages</h3>
                    <div id="passages-container" class="space-y-4">
                        <!-- Passages will be loaded here -->
                        <div class="text-gray-500 italic">Loading passages...</div>
                    </div>
                </div>

                <!-- Reading Test Area -->
                <div id="reading-test" class="hidden">
                    <div class="mb-6">
                        <h3 id="passage-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
                        <div id="passage-content" class="prose max-w-none mb-6 text-gray-700 leading-relaxed"></div>
                    </div>

                    <div id="questions-container" class="space-y-8 mb-8">
                        <!-- Questions will be loaded here -->
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button id="back-to-passages" class="btn-gray">
                            Back to Passages
                        </button>
                        <button id="submit-reading-answers" class="btn-primary">
                            <i class="fa fa-check mr-1"></i> Submit Answers
                        </button>
                    </div>
                </div>

                <!-- Reading Results Area -->
                <div id="reading-results" class="hidden">
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Test Results</h3>
                        <div class="mb-4">
                            <p class="text-gray-700 mb-2">Score: <span id="reading-score" class="font-bold text-primary"></span>/100</p>
                            <p class="text-gray-700">Correct Answers: <span id="reading-correct-count"></span>/<span id="reading-total-questions"></span></p>
                        </div>
                        
                        <div id="detailed-results" class="space-y-4 mt-6">
                            <!-- Detailed results will be loaded here -->
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button id="back-to-test" class="btn-gray">
                            Back to Test
                        </button>
                        <button id="back-to-passages-from-results" class="btn-primary">
                            <i class="fa fa-list mr-1"></i> Choose Another Passage
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Test History Module -->
        <section id="results-section" class="section hidden">
            <div class="max-w-5xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fa fa-bar-chart text-primary mr-3"></i> Test History
                    </h2>
                    
                    <div id="no-results-message" class="hidden py-16 text-center">
                        <i class="fa fa-line-chart text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">No test records available</p>
                        <p class="text-gray-400 mt-2">Take a test to see your progress</p>
                        <button id="go-to-test-btn" class="mt-4 btn-primary">
                            <i class="fa fa-check-square-o mr-1"></i> Take Test
                        </button>
                    </div>
                    
                    <!-- Word Statistics -->
                    <div id="word-statistics" class="mb-8 grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-4 text-gray-800">Exposure Rate</h3>
                            <div class="text-center">
                                <p class="text-4xl font-bold text-primary" id="exposure-rate">0%</p>
                                <p class="text-gray-600 mt-2">Percentage of words that have been tested</p>
                                <p class="text-gray-500 text-sm mt-1">
                                    <span id="tested-words-count">0</span> tested / <span id="total-words-count">0</span> total words
                                </p>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-4 text-gray-800">Familiarity Rate</h3>
                            <div class="text-center">
                                <p class="text-4xl font-bold text-secondary" id="familiarity-rate">0%</p>
                                <p class="text-gray-600 mt-2">Percentage of words with 3+ correct answers</p>
                                <p class="text-gray-500 text-sm mt-1">
                                    <span id="familiar-words-count">0</span> familiar / <span id="total-words-count-2">0</span> total words
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Study Activity Calendar -->
                    <div id="activity-calendar" class="mb-8 hidden">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Study Activity Calendar</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex items-center mb-4">
                                <span class="text-sm text-gray-500 mr-4">No Activity</span>
                                <div class="w-4 h-4 bg-gray-200 rounded mr-2"></div>
                                <span class="text-sm text-gray-500 mr-4">With Activity</span>
                                <div class="w-4 h-4 bg-primary rounded mr-2"></div>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-10 gap-1 sm:grid-cols-14 md:grid-cols-20 lg:grid-cols-25 xl:grid-cols-25">
                                <!-- 日历格子将在这里动态添加 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Score Trend Chart -->
                    <div id="results-chart-container" class="mb-8 h-64 hidden">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Score Trend</h3>
                        <canvas id="results-chart"></canvas>
                    </div>
                    
                    <!-- 测试结果列表 -->
                    <div class="overflow-auto rounded-lg border border-gray-200 mt-4">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Type</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Words</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correct</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Incorrect</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="results-list" class="bg-white divide-y divide-gray-200">
                                <!-- 测试结果列表将在这里动态添加 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-end">
                        <button id="clear-results-btn" class="btn-danger disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-trash mr-1"></i> Clear History
                        </button>
                    </div>
                </div>
                
                <!-- Reading Comprehension History -->
                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        <i class="fa fa-book text-primary mr-3"></i> Reading Comprehension History
                    </h2>
                    
                    <div id="no-reading-results-message" class="hidden py-16 text-center">
                        <i class="fa fa-book text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">No reading comprehension records available</p>
                        <p class="text-gray-400 mt-2">Take a reading test to see your progress</p>
                        <button id="go-to-reading-btn" class="mt-4 btn-primary">
                            <i class="fa fa-book mr-1"></i> Take Reading Test
                        </button>
                    </div>
                    
                    <!-- Reading Comprehension Score Trend Chart -->
                    <div id="reading-results-chart-container" class="mb-8 h-64 hidden">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Reading Score Trend</h3>
                        <canvas id="reading-results-chart"></canvas>
                    </div>
                    
                    <!-- Reading Comprehension Results List -->
                    <div class="overflow-auto rounded-lg border border-gray-200 mt-4">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Passage Title</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Questions</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correct</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Incorrect</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reading-results-list" class="bg-white divide-y divide-gray-200">
                                <!-- Reading comprehension results will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-end">
                        <button id="clear-reading-results-btn" class="btn-danger disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-trash mr-1"></i> Clear Reading History
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Add Word Dialog -->
    <div id="add-word-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 transform transition-all">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Add New Word</h3>
                    <button id="close-add-word" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="new-word-english" class="block text-sm font-medium text-gray-700 mb-1">English Word</label>
                        <input 
                            type="text" 
                            id="new-word-english" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            placeholder="Enter English word"
                        >
                    </div>
                    
                    <div>
                        <label for="new-word-chinese" class="block text-sm font-medium text-gray-700 mb-1">Chinese Definition</label>
                        <input 
                            type="text" 
                            id="new-word-chinese" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            placeholder="Enter Chinese definition"
                        >
                    </div>
                    
                    <div>
                        <label for="new-word-example" class="block text-sm font-medium text-gray-700 mb-1">Example (Optional)</label>
                        <textarea 
                            id="new-word-example" 
                            rows="3" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            placeholder="Enter example sentence"
                        ></textarea>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-6 py-3 rounded-b-xl flex justify-end space-x-3">
                <button id="cancel-add-word" class="btn-gray">
                    Cancel
                </button>
                <button id="save-new-word" class="btn-primary">
                    Save Word
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Word Dialog -->
    <div id="edit-word-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 transform transition-all">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Edit Word</h3>
                    <button id="close-edit-word" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <input type="hidden" id="edit-word-id">
                    <div>
                        <label for="edit-word-english" class="block text-sm font-medium text-gray-700 mb-1">English Word</label>
                        <input 
                            type="text" 
                            id="edit-word-english" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            placeholder="Enter English word"
                        >
                    </div>
                    
                    <div>
                        <label for="edit-word-chinese" class="block text-sm font-medium text-gray-700 mb-1">Chinese Definition</label>
                        <input 
                            type="text" 
                            id="edit-word-chinese" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            placeholder="Enter Chinese definition"
                        >
                    </div>
                    
                    <div>
                        <label for="edit-word-example" class="block text-sm font-medium text-gray-700 mb-1">Example (Optional)</label>
                        <textarea 
                            id="edit-word-example" 
                            rows="3" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-custom"
                            placeholder="Enter example sentence"
                        ></textarea>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-6 py-3 rounded-b-xl flex justify-end space-x-3">
                <button id="cancel-edit-word" class="btn-gray">
                    Cancel
                </button>
                <button id="save-edit-word" class="btn-primary">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirm-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 transform transition-all">
            <div class="p-6">
                <h3 id="confirm-title" class="text-lg font-semibold text-gray-800 mb-2">Confirm Action</h3>
                        <p id="confirm-message" class="text-gray-600">Are you sure you want to perform this action?</p>
            </div>
            
            <div class="bg-gray-50 px-6 py-3 rounded-b-xl flex justify-end space-x-3">
                <button id="confirm-cancel" class="btn-gray">
                    Cancel
                </button>
                <button id="confirm-ok" class="btn-danger">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-2 mb-4 md:mb-0">
                    <i class="fa fa-book text-primary text-xl"></i>
                    <span class="text-lg font-bold">VocabMaster</span>
                </div>
                
                <div class="text-gray-400 text-sm">
                    &copy; 2023 VocabMaster. All rights reserved.
                </div>
            </div>
        </div>
    </footer>

    <script>
        // 全局定义API基础URL
        window.API_BASE_URL = 'http://localhost:3003/api';
        
        // 当前选中的单词ID列表
        let selectedWordIds = [];
        
        // 当前测试状态
        let currentTest = {
            words: [],
            currentIndex: 0,
            correctCount: 0,
            incorrectCount: 0,
            results: []
        };
        
        // 初始化函数
        function init() {
            // 初始化菜单导航
            initNavigation();
            
            // 初始化各个模块
            initImportModule();
            initManageModule();
            initTestModule();
            initMistakesModule();
            initResultsModule();
            initSettingModule();
            initReadingComprehension();
            
            // 初始化确认对话框
            initConfirmDialog();
            
            // 导入初始单词数据
            importInitialWords();
        }
        
        // 初始化菜单导航
        function initNavigation() {
            // 桌面导航
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sectionId = this.id.replace('nav-', '') + '-section';
                    showSection(sectionId);
                    
                    // 更新活动状态
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('active', 'text-primary', 'border-b-2', 'border-primary');
                        b.classList.add('text-gray-600');
                    });
                    this.classList.add('active', 'text-primary', 'border-b-2', 'border-primary');
                    this.classList.remove('text-gray-600');
                    
                    // 移动端菜单隐藏
                    document.getElementById('mobile-menu').classList.add('hidden');
                });
            });
            
            // 移动端菜单按钮
            document.getElementById('mobile-menu-btn').addEventListener('click', function() {
                const mobileMenu = document.getElementById('mobile-menu');
                mobileMenu.classList.toggle('hidden');
            });
            
            // 移动端导航
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sectionId = this.id.replace('mobile-', '') + '-section';
                    showSection(sectionId);
                    
                    // 更新活动状态
                    document.querySelectorAll('.mobile-nav-btn').forEach(b => {
                        b.classList.remove('active', 'text-primary');
                        b.classList.add('text-gray-600');
                    });
                    this.classList.add('active', 'text-primary');
                    this.classList.remove('text-gray-600');
                    
                    // 关闭移动端菜单
                    document.getElementById('mobile-menu').classList.add('hidden');
                });
            });
        }
        
        // 显示指定模块
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            
            // 如果是管理模块，重新加载单词列表
            if (sectionId === 'manage-section') {
                loadWords();
            }
            // 如果是错词模块，重新加载错词列表
            if (sectionId === 'mistakes-section') {
                loadMistakes();
            }
            // 如果是测试模块，初始化测试设置
            if (sectionId === 'test-section') {
                initTestSettings();
            }
            // 如果是结果模块，加载测试结果
            if (sectionId === 'results-section') {
                loadTestResults();
            }
            // 如果是设置模块，初始化设置
            if (sectionId === 'setting-section') {
                initSettingModule();
            }
        }
        
        // 初始化导入模块
        function initImportModule() {
            const importTextBtn = document.getElementById('import-text-btn');
            const wordsTextarea = document.getElementById('words-textarea');
            const importResults = document.getElementById('import-results');
            const importSuccess = document.getElementById('import-success');
            const importDuplicates = document.getElementById('import-duplicates');
            const importErrors = document.getElementById('import-errors');
            const importedCount = document.getElementById('imported-count');
            const duplicatesList = document.getElementById('duplicates-list');
            const errorsList = document.getElementById('errors-list');
            const errorsCount = document.getElementById('errors-count');
            const closeImportResults = document.getElementById('close-import-results');
            const goToManageBtn = document.getElementById('go-to-manage-btn');
            const skipDuplicatesBtn = document.getElementById('skip-duplicates-btn');
            const updateDuplicatesBtn = document.getElementById('update-duplicates-btn');
            
            let currentImportData = null;
            
            // 导入文本按钮点击事件
            importTextBtn.addEventListener('click', function() {
                const text = wordsTextarea.value.trim();
                if (!text) {
                    alert('请输入单词内容');
                    return;
                }
                
                // 解析文本内容
                const lines = text.split('\n');
                const words = [];
                const errorLines = [];
                
                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return;
                    
                    const parts = trimmedLine.split(',');
                    if (parts.length < 2) {
                        errorLines.push({ line: index + 1, text: trimmedLine, reason: '格式不正确，缺少逗号分隔' });
                        return;
                    }
                    
                    words.push({
                        english: parts[0].trim(),
                        chinese: parts[1].trim(),
                        example: parts.length > 2 ? parts[2].trim() : ''
                    });
                });
                
                // 显示错误信息
                if (errorLines.length > 0) {
                    errorsCount.textContent = errorLines.length;
                    errorsList.innerHTML = '';
                    errorLines.forEach(error => {
                        const errorItem = document.createElement('div');
                        errorItem.innerHTML = `<strong>行 ${error.line}:</strong> ${error.text} - ${error.reason}`;
                        errorsList.appendChild(errorItem);
                    });
                    importErrors.classList.remove('hidden');
                    importResults.classList.remove('hidden');
                    return;
                }
                
                // 批量导入单词
                if (words.length > 0) {
                    importWordsBatch(words);
                }
            });
            
            // 批量导入单词
            function importWordsBatch(words) {
                fetch(`${API_BASE_URL}/words/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(words)
                })
                .then(response => response.json())
                .then(results => {
                    currentImportData = results;
                    
                    // 显示导入结果
                    importResults.classList.remove('hidden');
                    
                    // 显示成功信息
                    if (results.success.length > 0) {
                        importedCount.textContent = results.success.length;
                        importSuccess.classList.remove('hidden');
                    } else {
                        importSuccess.classList.add('hidden');
                    }
                    
                    // 显示重复信息
                    if (results.duplicate.length > 0) {
                        duplicatesList.innerHTML = '';
                        results.duplicate.forEach((item, index) => {
                            const duplicateItem = document.createElement('div');
                            duplicateItem.className = 'p-3 border border-gray-200 rounded-lg';
                            duplicateItem.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-medium">${item.word.english}</p>
                                        <p class="text-gray-600 text-sm">新: ${item.word.chinese}</p>
                                        <p class="text-gray-600 text-sm">现有: ${item.existingWord.chinese}</p>
                                    </div>
                                    <input type="checkbox" class="duplicate-checkbox" data-index="${index}" checked>
                                </div>
                            `;
                            duplicatesList.appendChild(duplicateItem);
                        });
                        importDuplicates.classList.remove('hidden');
                    } else {
                        importDuplicates.classList.add('hidden');
                    }
                    
                    // 显示错误信息
                    if (results.error.length > 0) {
                        errorsCount.textContent = results.error.length;
                        errorsList.innerHTML = '';
                        results.error.forEach(error => {
                            const errorItem = document.createElement('div');
                            errorItem.innerHTML = `<strong>单词 ${error.word.english}:</strong> ${error.reason}`;
                            errorsList.appendChild(errorItem);
                        });
                        importErrors.classList.remove('hidden');
                    } else {
                        importErrors.classList.add('hidden');
                    }
                    
                    // 如果没有重复和错误，自动清空文本区域
                    if (results.duplicate.length === 0 && results.error.length === 0) {
                        wordsTextarea.value = '';
                    }
                })
                .catch(error => {
                    console.error('导入单词失败:', error);
                    alert('导入单词失败，请重试');
                });
            }
            
            // 跳过重复单词
            skipDuplicatesBtn.addEventListener('click', function() {
                importDuplicates.classList.add('hidden');
                wordsTextarea.value = '';
            });
            
            // 更新重复单词
            updateDuplicatesBtn.addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.duplicate-checkbox');
                const wordsToUpdate = [];
                
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        const index = parseInt(checkbox.dataset.index);
                        const duplicateItem = currentImportData.duplicate[index];
                        wordsToUpdate.push({
                            id: duplicateItem.existingWord.id,
                            english: duplicateItem.word.english,
                            chinese: duplicateItem.word.chinese,
                            example: duplicateItem.word.example
                        });
                    }
                });
                
                // 批量更新单词
                Promise.all(
                    wordsToUpdate.map(word => 
                        fetch(`${API_BASE_URL}/words/${word.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(word)
                        })
                    )
                )
                .then(() => {
                    importDuplicates.classList.add('hidden');
                    wordsTextarea.value = '';
                    alert('单词更新成功');
                })
                .catch(error => {
                    console.error('更新单词失败:', error);
                    alert('更新单词失败，请重试');
                });
            });
            
            // 关闭导入结果
            closeImportResults.addEventListener('click', function() {
                importResults.classList.add('hidden');
            });
            
            // 前往管理页面
            goToManageBtn.addEventListener('click', function() {
                document.getElementById('nav-manage').click();
            });
        }
        
        // 初始化管理模块
        function initManageModule() {
            const searchWords = document.getElementById('search-words');
            const addWordBtn = document.getElementById('add-word-btn');
            const clearWordsBtn = document.getElementById('clear-words-btn');
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            const exportWordsBtn = document.getElementById('export-words-btn');
            const selectAllWords = document.getElementById('select-all-words');
            const goToImportBtn = document.getElementById('go-to-import-btn');
            
            // 搜索单词 - 按回车时触发
            searchWords.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query.length > 0) {
                        searchWordsByName(query);
                    } else {
                        loadWords();
                    }
                }
            });
            
            // 添加单词按钮
            addWordBtn.addEventListener('click', function() {
                showAddWordDialog();
            });
            
            // 清空所有单词
            clearWordsBtn.addEventListener('click', function() {
                showConfirmDialog(
                    '清空单词库',
                    '确定要清空所有单词吗？此操作不可撤销。',
                    function() {
                        clearAllWords();
                    }
                );
            });
            
            // 删除选中单词
            deleteSelectedBtn.addEventListener('click', function() {
                if (selectedWordIds.length > 0) {
                    showConfirmDialog(
                        '删除选中单词',
                        `确定要删除选中的 ${selectedWordIds.length} 个单词吗？此操作不可撤销。`,
                        function() {
                            deleteSelectedWords();
                        }
                    );
                }
            });
            
            // 全选/取消全选
            selectAllWords.addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.word-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateSelectedWordIds();
            });
            
            // 前往导入页面
            goToImportBtn.addEventListener('click', function() {
                document.getElementById('nav-import').click();
            });
            
            // 初始化添加单词对话框
            initAddWordDialog();
            
            // 初始化编辑单词对话框
            initEditWordDialog();

            // 导出单词按钮
            exportWordsBtn.addEventListener('click', function() {
                exportWords();
            });
        }
        
        // 导出单词列表为Excel
        function exportWords() {
            fetch(`${API_BASE_URL}/words`)
                .then(response => {
                    console.log('导出API 状态码:', response.status);
                    if (!response.ok) {
                        throw new Error(`获取导出数据失败: ${response.status}`);
                    }
                    // 检查响应类型是否为JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('API返回非JSON格式数据');
                    }
                    return response.json();
                })
                .then(words => {
                    // 创建CSV内容
                    let csvContent = '英语,中文,例句,添加日期\n';
                    
                    // 添加每行数据
                    words.forEach(word => {
                        // 处理CSV特殊字符（转义逗号、引号）
                        const english = word.english.replace(/"/g, '""');
                        const chinese = word.chinese.replace(/"/g, '""');
                        const example = word.example ? word.example.replace(/"/g, '""') : '';
                        const date = formatDate(word.added_date);
                        
                        // 添加到CSV内容
                        csvContent += `"${english}","${chinese}","${example}","${date}"\n`;
                    });
                    
                    // 创建Blob对象
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    
                    // 创建下载链接
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `vocabulary_export_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    
                    // 添加到页面并触发下载
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(error => {
                    console.error('导出单词失败:', error);
                    alert('导出单词失败，请重试');
                });
        }

        // 加载单词列表
        function loadWords() {
            // 先获取单词总数
            fetch(`${API_BASE_URL}/words/count`)
                .then(response => {
                    console.log('Count API 状态码:', response.status);
                    if (!response.ok) {
                        // 检查响应类型，看看是否返回HTML错误页面
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('text/html')) {
                            throw new Error(`获取单词总数失败: 服务器返回HTML错误页面，状态码 ${response.status}`);
                        }
                        throw new Error(`获取单词总数失败: ${response.status}`);
                    }
                    // 检查响应类型是否为JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('API返回非JSON格式数据');
                    }
                    return response.json();
                })
                .then(countData => {
                    console.log('获取到单词总数:', countData.total || 0);
                    const totalWords = document.getElementById('total-words');
                    // 更新单词总数显示
                    totalWords.textContent = countData.total || 0;
                    
                    // 然后获取单词列表
                    return fetch(`${API_BASE_URL}/words`);
                })
                .then(response => {
                    console.log('Words API 状态码:', response.status);
                    if (!response.ok) {
                        // 检查响应类型，看看是否返回HTML错误页面
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('text/html')) {
                            throw new Error(`获取单词列表失败: 服务器返回HTML错误页面，状态码 ${response.status}`);
                        }
                        throw new Error(`获取单词列表失败: ${response.status}`);
                    }
                    // 检查响应类型是否为JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('API返回非JSON格式数据');
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('加载单词失败:', error);
                    alert('加载单词失败: ' + error.message);
                    // 重置UI显示
                    const wordsList = document.getElementById('words-list');
                    const noWordsMessage = document.getElementById('no-words-message');
                    const totalWords = document.getElementById('total-words');
                    const clearWordsBtn = document.getElementById('clear-words-btn');
                    
                    wordsList.innerHTML = '';
                    noWordsMessage.classList.remove('hidden');
                    noWordsMessage.textContent = '加载单词失败，请刷新页面重试';
                    totalWords.textContent = '0';
                    clearWordsBtn.disabled = true;
                    document.getElementById('export-words-btn').disabled = true;
                    document.getElementById('select-all-words').checked = false;
                    selectedWordIds = [];
                    
                    // 返回一个空数组以避免后续处理错误
                    return [];
                })
                .then(words => {
                    const wordsList = document.getElementById('words-list');
                    const noWordsMessage = document.getElementById('no-words-message');
                    const clearWordsBtn = document.getElementById('clear-words-btn');
                    const selectAllWords = document.getElementById('select-all-words');
                    
                    // 更新按钮状态
                    clearWordsBtn.disabled = words.length === 0;
                    document.getElementById('export-words-btn').disabled = words.length === 0;
                    
                    // 全选按钮取消选中
                    selectAllWords.checked = false;
                    
                    // 清空选中的单词ID
                    selectedWordIds = [];
                    
                    if (words.length === 0) {
                        wordsList.innerHTML = '';
                        noWordsMessage.classList.remove('hidden');
                    } else {
                        noWordsMessage.classList.add('hidden');
                        wordsList.innerHTML = '';
                        
                        words.forEach(word => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50 transition-custom';
                            row.innerHTML = `
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <input type="checkbox" class="word-checkbox text-primary focus:ring-primary rounded" data-id="${word.id}">
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="font-medium text-gray-900">${word.english}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-normal min-w-[96px] max-w-[96px]">
                                    <div class="text-gray-700">${word.chinese}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-gray-600 text-sm ${word.example ? '' : 'text-gray-400'}">${word.example || '无'}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                    ${formatDate(word.added_date)}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                    <button class="text-primary hover:text-primary/80 mr-3 edit-word-btn" data-id="${word.id}">
                                        <i class="fa fa-pencil mr-1"></i> 编辑
                                    </button>
                                    <button class="text-danger hover:text-danger/80 delete-word-btn" data-id="${word.id}">
                                        <i class="fa fa-trash mr-1"></i> 删除
                                    </button>
                                </td>
                            `;
                            wordsList.appendChild(row);
                        });
                        
                        // 添加复选框事件
                        document.querySelectorAll('.word-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                updateSelectedWordIds();
                            });
                        });
                        
                        // 添加编辑按钮事件
                        document.querySelectorAll('.edit-word-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const wordId = parseInt(this.dataset.id);
                                showEditWordDialog(wordId);
                            });
                        });
                        
                        // 添加删除按钮事件
                        document.querySelectorAll('.delete-word-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const wordId = parseInt(this.dataset.id);
                                deleteWord(wordId);
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('加载单词失败:', error);
                    // 显示错误信息
                    const wordsList = document.getElementById('words-list');
                    const noWordsMessage = document.getElementById('no-words-message');
                    wordsList.innerHTML = '';
                    noWordsMessage.classList.remove('hidden');
                    noWordsMessage.innerHTML = `加载失败: ${error.message}`;
                    noWordsMessage.classList.add('text-danger');
                    // 重置计数显示
                    document.getElementById('total-words').textContent = '0';
                    // 禁用相关按钮
                    document.getElementById('clear-words-btn').disabled = true;
                    document.getElementById('export-words-btn').disabled = true;
                });
        }
        
        // 搜索单词
        function searchWordsByName(query) {
            fetch(`${API_BASE_URL}/words/search/${query}`)
                .then(response => {
                    console.log('搜索API 状态码:', response.status);
                    if (!response.ok) {
                        throw new Error(`搜索失败: ${response.status}`);
                    }
                    // 检查响应类型是否为JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('API返回非JSON格式数据');
                    }
                    return response.json();
                })
                .then(words => {
                    const wordsList = document.getElementById('words-list');
                    const noWordsMessage = document.getElementById('no-words-message');
                    
                    if (words.length === 0) {
                        wordsList.innerHTML = '';
                        noWordsMessage.classList.remove('hidden');
                        noWordsMessage.querySelector('p:first-of-type').textContent = '未找到匹配的单词';
                        noWordsMessage.querySelector('p:last-of-type').textContent = '请尝试其他搜索词';
                    } else {
                        noWordsMessage.classList.add('hidden');
                        wordsList.innerHTML = '';
                        
                        words.forEach(word => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50 transition-custom';
                            row.innerHTML = `
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <input type="checkbox" class="word-checkbox" data-id="${word.id}" class="text-primary focus:ring-primary rounded">
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="font-medium text-gray-900">${word.english}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="text-gray-700">${word.chinese}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-gray-600 text-sm ${word.example ? '' : 'text-gray-400'}">${word.example || '无'}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                    ${formatDate(word.added_date)}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                    <button class="text-primary hover:text-primary/80 mr-3 edit-word-btn" data-id="${word.id}">
                                        <i class="fa fa-pencil mr-1"></i> 编辑
                                    </button>
                                    <button class="text-danger hover:text-danger/80 delete-word-btn" data-id="${word.id}">
                                        <i class="fa fa-trash mr-1"></i> 删除
                                    </button>
                                </td>
                            `;
                            wordsList.appendChild(row);
                        });
                        
                        // 添加复选框事件
                        document.querySelectorAll('.word-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                updateSelectedWordIds();
                            });
                        });
                        
                        // 添加编辑按钮事件
                        document.querySelectorAll('.edit-word-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const wordId = parseInt(this.dataset.id);
                                showEditWordDialog(wordId);
                            });
                        });
                        
                        // 添加删除按钮事件
                        document.querySelectorAll('.delete-word-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const wordId = parseInt(this.dataset.id);
                                deleteWord(wordId);
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('搜索单词失败:', error);
                });
        }
        
        // 更新选中的单词ID
        function updateSelectedWordIds() {
            const checkboxes = document.querySelectorAll('.word-checkbox:checked');
            selectedWordIds = Array.from(checkboxes).map(checkbox => parseInt(checkbox.dataset.id));
            
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            deleteSelectedBtn.disabled = selectedWordIds.length === 0;
        }
        
        // 删除单个单词
        function deleteWord(wordId) {
            fetch(`${API_BASE_URL}/words/${wordId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    loadWords();
                } else {
                    alert('删除单词失败');
                }
            })
            .catch(error => {
                console.error('删除单词失败:', error);
                alert('删除单词失败，请重试');
            });
        }
        
        // 删除选中的单词
        function deleteSelectedWords() {
            const ids = selectedWordIds.join(',');
            fetch(`${API_BASE_URL}/words/batch/${ids}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    loadWords();
                } else {
                    alert('删除选中单词失败');
                }
            })
            .catch(error => {
                console.error('删除选中单词失败:', error);
                alert('删除选中单词失败，请重试');
            });
        }
        
        // 清空所有单词
        function clearAllWords() {
            fetch(`${API_BASE_URL}/words`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    loadWords();
                } else {
                    alert('清空单词库失败');
                }
            })
            .catch(error => {
                console.error('清空单词库失败:', error);
                alert('清空单词库失败，请重试');
            });
        }
        
        // 初始化添加单词对话框
        function initAddWordDialog() {
            const addWordDialog = document.getElementById('add-word-dialog');
            const closeAddWord = document.getElementById('close-add-word');
            const cancelAddWord = document.getElementById('cancel-add-word');
            const saveNewWord = document.getElementById('save-new-word');
            const newWordEnglish = document.getElementById('new-word-english');
            const newWordChinese = document.getElementById('new-word-chinese');
            const newWordExample = document.getElementById('new-word-example');
            
            // 关闭对话框
            closeAddWord.addEventListener('click', function() {
                hideAddWordDialog();
            });
            
            cancelAddWord.addEventListener('click', function() {
                hideAddWordDialog();
            });
            
            // 保存新单词
            saveNewWord.addEventListener('click', function() {
                const english = newWordEnglish.value.trim();
                const chinese = newWordChinese.value.trim();
                const example = newWordExample.value.trim();
                
                if (!english || !chinese) {
                    alert('英文单词和中文释义不能为空');
                    return;
                }
                
                // 添加新单词
                fetch(`${API_BASE_URL}/words`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ english, chinese, example })
                })
                .then(response => {
                    if (response.status === 409) {
                        return response.json().then(data => {
                            throw new Error(`单词 "${english}" 已存在`);
                        });
                    }
                    if (!response.ok) {
                        throw new Error('添加单词失败');
                    }
                    return response.json();
                })
                .then(() => {
                    hideAddWordDialog();
                    loadWords();
                })
                .catch(error => {
                    console.error('添加单词失败:', error);
                    alert(error.message || '添加单词失败，请重试');
                });
            });
        }
        
        // 显示添加单词对话框
        function showAddWordDialog() {
            const addWordDialog = document.getElementById('add-word-dialog');
            const newWordEnglish = document.getElementById('new-word-english');
            const newWordChinese = document.getElementById('new-word-chinese');
            const newWordExample = document.getElementById('new-word-example');
            
            // 清空输入框
            newWordEnglish.value = '';
            newWordChinese.value = '';
            newWordExample.value = '';
            
            // 显示对话框
            addWordDialog.classList.remove('hidden');
            
            // 自动聚焦第一个输入框
            setTimeout(() => {
                newWordEnglish.focus();
            }, 100);
        }
        
        // 隐藏添加单词对话框
        function hideAddWordDialog() {
            const addWordDialog = document.getElementById('add-word-dialog');
            addWordDialog.classList.add('hidden');
        }
        
        // 初始化编辑单词对话框
        function initEditWordDialog() {
            const editWordDialog = document.getElementById('edit-word-dialog');
            const closeEditWord = document.getElementById('close-edit-word');
            const cancelEditWord = document.getElementById('cancel-edit-word');
            const saveEditWord = document.getElementById('save-edit-word');
            const editWordId = document.getElementById('edit-word-id');
            const editWordEnglish = document.getElementById('edit-word-english');
            const editWordChinese = document.getElementById('edit-word-chinese');
            const editWordExample = document.getElementById('edit-word-example');
            
            // 关闭对话框
            closeEditWord.addEventListener('click', function() {
                hideEditWordDialog();
            });
            
            cancelEditWord.addEventListener('click', function() {
                hideEditWordDialog();
            });
            
            // 保存编辑后的单词
            saveEditWord.addEventListener('click', function() {
                const id = editWordId.value;
                const english = editWordEnglish.value.trim();
                const chinese = editWordChinese.value.trim();
                const example = editWordExample.value.trim();
                
                if (!english || !chinese) {
                    alert('英文单词和中文释义不能为空');
                    return;
                }
                
                // 更新单词
                fetch(`${API_BASE_URL}/words/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ english, chinese, example })
                })
                .then(response => {
                    if (response.status === 409) {
                        return response.json().then(data => {
                            throw new Error(`单词 "${english}" 已存在`);
                        });
                    }
                    if (!response.ok) {
                        throw new Error('更新单词失败');
                    }
                    return response.json();
                })
                .then(() => {
                    hideEditWordDialog();
                    loadWords();
                })
                .catch(error => {
                    console.error('更新单词失败:', error);
                    alert(error.message || '更新单词失败，请重试');
                });
            });
        }
        
        // 显示编辑单词对话框
        function showEditWordDialog(wordId) {
            const editWordDialog = document.getElementById('edit-word-dialog');
            const editWordId = document.getElementById('edit-word-id');
            const editWordEnglish = document.getElementById('edit-word-english');
            const editWordChinese = document.getElementById('edit-word-chinese');
            const editWordExample = document.getElementById('edit-word-example');
            
            // 获取单词详情
            fetch(`${API_BASE_URL}/words/${wordId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取单词详情失败');
                    }
                    return response.json();
                })
                .then(word => {
                    // 填充表单
                    editWordId.value = word.id;
                    editWordEnglish.value = word.english;
                    editWordChinese.value = word.chinese;
                    editWordExample.value = word.example || '';
                    
                    // 显示对话框
                    editWordDialog.classList.remove('hidden');
                    
                    // 自动聚焦英文单词输入框
                    setTimeout(() => {
                        editWordEnglish.focus();
                    }, 100);
                })
                .catch(error => {
                    console.error('获取单词详情失败:', error);
                    alert('获取单词详情失败，请重试');
                });
        }
        
        // 隐藏编辑单词对话框
        function hideEditWordDialog() {
            const editWordDialog = document.getElementById('edit-word-dialog');
            editWordDialog.classList.add('hidden');
        }
        
        // 初始化测试模块
        function initTestModule() {
            const startTestBtn = document.getElementById('start-test-btn');
            const testCount = document.getElementById('test-count');
            const maxWordsText = document.getElementById('max-words-text');
            const showExampleBtn = document.getElementById('show-example-btn');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const restartTestBtn = document.getElementById('restart-test-btn');
            const reviewMistakesBtn = document.getElementById('review-mistakes-btn');
            const saveResultsBtn = document.getElementById('save-results-btn');
            const startReadingTestBtn = document.getElementById('start-reading-test-btn');
            
            // 开始测试
            startTestBtn.addEventListener('click', function() {
                startTest();
            });
            
            // 开始阅读理解测试
            startReadingTestBtn.addEventListener('click', function() {
                showSection('reading-section');
                loadPassages();
            });
            
            // 显示例句
            showExampleBtn.addEventListener('click', function() {
                const exampleContainer = document.getElementById('example-container');
                exampleContainer.classList.toggle('hidden');
            });
            
            // 下一题
            nextQuestionBtn.addEventListener('click', function() {
                showNextQuestion();
            });
            
            // 重新测试
            restartTestBtn.addEventListener('click', function() {
                document.getElementById('test-settings').classList.remove('hidden');
                document.getElementById('test-results').classList.add('hidden');
                initTestSettings();
            });
            
            // 查看错误
            reviewMistakesBtn.addEventListener('click', function() {
                document.getElementById('nav-mistakes').click();
            });
            
            // 保存成绩
            saveResultsBtn.addEventListener('click', function() {
                saveTestResult();
            });
        }
        
        // 初始化测试设置
        function initTestSettings() {
            const startTestBtn = document.getElementById('start-test-btn');
            const maxWordsText = document.getElementById('max-words-text');
            
            // 获取单词总数
            fetch(`${API_BASE_URL}/words/count`)
                .then(response => response.json())
                .then(data => {
                    const wordCount = data.count;
                    maxWordsText.textContent = `最大: ${wordCount}`;
                    
                    // 更新测试数量输入框的最大值
                    document.getElementById('test-count').max = wordCount;
                    
                    // 更新开始测试按钮状态
                    startTestBtn.disabled = wordCount === 0;
                })
                .catch(error => {
                    console.error('获取单词数量失败:', error);
                });
        }
        
        // 开始测试
        function startTest() {
            const testCount = parseInt(document.getElementById('test-count').value);
            const testType = document.querySelector('input[name="test-type"]:checked').value;
            
            // 添加调试日志，记录用户选择的测试类型
            console.log('用户选择的测试类型:', testType);
            
            // 获取随机单词
            fetch(`${API_BASE_URL}/test/random/${testCount}`)
                .then(response => response.json())
                .then(words => {
                    // 初始化测试状态
                    currentTest = {
                        words: words,
                        currentIndex: 0,
                        correctCount: 0,
                        incorrectCount: 0,
                        results: [],
                        testType: testType
                    };
                    
                    // 添加调试日志，记录初始化的测试类型
                    console.log('初始化的测试类型:', currentTest.testType);
                    
                    // 显示测试进行中界面
                    document.getElementById('test-settings').classList.add('hidden');
                    document.getElementById('test-in-progress').classList.remove('hidden');
                    
                    // 更新当前问题和总问题数
                    document.getElementById('current-question').textContent = 1;
                    document.getElementById('total-questions').textContent = words.length;
                    
                    // 显示第一个问题
                    showQuestion();
                })
                .catch(error => {
                    console.error('获取测试单词失败:', error);
                    alert('获取测试单词失败，请重试');
                });
        }
        
        // 显示问题
        function showQuestion() {
            const currentWord = currentTest.words[currentTest.currentIndex];
            const mcQuestion = document.getElementById('mc-question');
            const wordExample = document.getElementById('word-example');
            const optionsContainer = document.getElementById('options-container');
            const answerFeedback = document.getElementById('answer-feedback');
            const exampleContainer = document.getElementById('example-container');
            
            // 隐藏答案反馈和例句
            answerFeedback.classList.add('hidden');
            exampleContainer.classList.add('hidden');
            
            // 根据测试类型显示问题
            const isChineseToEnglish = currentTest.testType === 'chinese-to-english-multiple';
            const isSentenceFilling = currentTest.testType === 'sentence-filling-multiple';
            
            if (isChineseToEnglish) {
                // Chinese → English 测试
                mcQuestion.textContent = currentWord.chinese;
            } else if (isSentenceFilling) {
                // Sentence Filling 测试
                // 将例句中的单词替换为空白
                const regex = new RegExp(`\\b${currentWord.english}\\b`, 'gi');
                const maskedSentence = currentWord.example ? 
                    currentWord.example.replace(regex, '______') : 
                    `Complete the sentence with the correct word: ${currentWord.english}`;
                mcQuestion.textContent = maskedSentence;
            } else {
                // English → Chinese 测试
                mcQuestion.textContent = currentWord.english;
            }
            
            wordExample.textContent = currentWord.example || '无例句';
            
            // 获取随机选项
            fetch(`${API_BASE_URL}/test/distractors/${currentWord.id}/4`)
                .then(response => response.json())
                .then(distractors => {
                    // 清空选项容器
                    optionsContainer.innerHTML = '';
                    
                    // 创建包含正确答案的完整选项列表
                    let allOptions;
                    const isSentenceFilling = currentTest.testType === 'sentence-filling-multiple';
                    
                    if (isChineseToEnglish || isSentenceFilling) {
                        // Chinese → English 测试 或 Sentence Filling 测试：选项是英文单词
                        // 从当前测试的单词中随机选择一些作为干扰项
                        const shuffledWords = [...currentTest.words].sort(() => 0.5 - Math.random());
                        const distractorWords = shuffledWords.filter(word => word.id !== currentWord.id).slice(0, 4);
                        
                        // 创建选项列表，包含正确答案和干扰项
                        allOptions = [...distractorWords.map(word => word.english), currentWord.english];
                        
                        // 去重
                        allOptions = [...new Set(allOptions)];
                        
                        // 确保有5个选项，如果不够就从当前测试的单词中补充
                        if (allOptions.length < 5) {
                            for (let i = allOptions.length; i < 5; i++) {
                                const randomIndex = Math.floor(Math.random() * currentTest.words.length);
                                allOptions.push(currentTest.words[randomIndex].english);
                            }
                            // 再次去重
                            allOptions = [...new Set(allOptions)];
                        }
                    } else {
                        // English → Chinese 测试：选项是中文释义
                        allOptions = [...distractors.map(d => d.chinese), currentWord.chinese];
                    }
                    
                    // 随机排序选项
                    for (let i = allOptions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
                    }
                    
                    // 为options-container添加总背景框样式
                    optionsContainer.className = 'bg-white border border-gray-200 rounded-xl p-4 space-y-3 transition-colors duration-300';
                    
                    // 记录正确答案索引，方便后续标识
                    const correctAnswerIndex = allOptions.findIndex(opt => {
                        if (isChineseToEnglish || isSentenceFilling) {
                            return opt === currentWord.english;
                        } else {
                            return opt === currentWord.chinese;
                        }
                    });
                    
                    // 显示选项
                    allOptions.forEach((option, index) => {
                        const optionElement = document.createElement('div');
                        optionElement.className = 'p-4 border border-gray-200 rounded-lg option-hover transition-colors duration-200';
                        optionElement.dataset.optionIndex = index;
                        if (index === correctAnswerIndex) {
                            optionElement.dataset.isCorrect = 'true';
                        }
                        
                        optionElement.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-6 h-6 flex-shrink-0 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 mr-3">
                                    ${String.fromCharCode(65 + index)}
                                </div>
                                <span>${option}</span>
                            </div>
                        `;
                        
                        // 根据测试类型设置不同的点击事件
                        if (isChineseToEnglish || isSentenceFilling) {
                            optionElement.addEventListener('click', function() {
                                checkAnswer({ english: option }, index);
                            });
                        } else {
                            optionElement.addEventListener('click', function() {
                                checkAnswer({ chinese: option }, index);
                            });
                        }
                        
                        optionsContainer.appendChild(optionElement);
                    });
                })
                .catch(error => {
                    console.error('获取选项失败:', error);
                });
        }
        
        // 检查答案
        function checkAnswer(selectedOption, selectedIndex) {
            const currentWord = currentTest.words[currentTest.currentIndex];
            const answerFeedback = document.getElementById('answer-feedback');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackMessage = document.getElementById('feedback-message');
            const optionsContainer = document.getElementById('options-container');
            const isChineseToEnglish = currentTest.testType === 'chinese-to-english-multiple';
            
            // 禁用所有选项
            Array.from(optionsContainer.children).forEach(option => {
                option.style.cursor = 'default';
                option.style.pointerEvents = 'none';
            });
            
            // 记录答案结果
            let isCorrect;
            const isSentenceFilling = currentTest.testType === 'sentence-filling-multiple';
            
            if (isChineseToEnglish || isSentenceFilling) {
                // Chinese → English 测试 或 Sentence Filling 测试
                isCorrect = selectedOption.english === currentWord.english;
            } else {
                // English → Chinese 测试
                isCorrect = selectedOption.chinese === currentWord.chinese;
            }
            
            // 获取当前选中的选项元素
            const selectedOptionElement = optionsContainer.querySelector(`[data-option-index="${selectedIndex}"]`);
            // 获取正确答案的选项元素
            const correctOptionElement = optionsContainer.querySelector('[data-is-correct="true"]');
            const correctIndex = correctOptionElement ? correctOptionElement.dataset.optionIndex : -1;
            
            if (isCorrect) {
                // 答案正确
                currentTest.correctCount++;
                feedbackIcon.className = 'fa fa-check-circle text-green-500 text-xl mt-0.5 mr-3';
                feedbackTitle.className = 'font-medium text-green-500';
                feedbackTitle.textContent = '回答正确！';
                
                if (isChineseToEnglish) {
                    feedbackMessage.textContent = `${currentWord.chinese} 的英文是 ${currentWord.english}`;
                } else if (isSentenceFilling) {
                    feedbackMessage.textContent = `正确答案是 ${currentWord.english}。完整句子：${currentWord.example || 'No example available'}`;
                } else {
                    feedbackMessage.textContent = `${currentWord.english} 的意思是 ${currentWord.chinese}`;
                }
                
                answerFeedback.className = 'mt-6 p-4 rounded-lg bg-green-50 border border-green-200';
                
                // 设置整个选项容器的背景为浅绿色
                optionsContainer.className = 'bg-green-50 border border-green-200 rounded-xl p-4 space-y-3 transition-colors duration-300';
                
                // 高亮显示选中的正确选项
                if (selectedOptionElement) {
                    selectedOptionElement.className = 'p-4 border border-green-300 rounded-lg bg-green-100 option-hover transition-colors duration-200';
                    // 添加正确标记
                    selectedOptionElement.querySelector('div:first-child').innerHTML += `
                        <i class="fa fa-check-circle text-green-500 ml-2"></i>
                    `;
                }
                
                // 更新错词状态
                updateMistakeStatus(currentWord.id, true);
                
                // 添加到结果
                currentTest.results.push({
                    word: currentWord,
                    correct: true,
                    selectedOption: selectedOption
                });
            } else {
                // 答案错误
                currentTest.incorrectCount++;
                feedbackIcon.className = 'fa fa-times-circle text-red-500 text-xl mt-0.5 mr-3';
                feedbackTitle.className = 'font-medium text-red-500';
                feedbackTitle.textContent = '回答错误！';
                
                if (isChineseToEnglish) {
                    feedbackMessage.textContent = `${currentWord.chinese} 的英文是 ${currentWord.english}，您选择了 ${selectedOption.english}`;
                } else if (isSentenceFilling) {
                    feedbackMessage.textContent = `正确答案是 ${currentWord.english}，您选择了 ${selectedOption.english}。完整句子：${currentWord.example || 'No example available'}`;
                } else {
                    feedbackMessage.textContent = `${currentWord.english} 的意思是 ${currentWord.chinese}，您选择了 ${selectedOption.chinese}`;
                }
                
                answerFeedback.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200';
                
                // 设置整个选项容器的背景为浅红色
                optionsContainer.className = 'bg-red-50 border border-red-200 rounded-xl p-4 space-y-3 transition-colors duration-300';
                
                // 高亮显示选中的错误选项
                if (selectedOptionElement) {
                    selectedOptionElement.className = 'p-4 border border-red-300 rounded-lg bg-red-100 option-hover transition-colors duration-200';
                    // 添加错误标记
                    selectedOptionElement.querySelector('div:first-child').innerHTML += `
                        <i class="fa fa-times-circle text-red-500 ml-2"></i>
                    `;
                }
                
                // 高亮显示正确答案选项
                if (correctOptionElement && correctIndex !== selectedIndex) {
                    correctOptionElement.className = 'p-4 border border-green-300 rounded-lg bg-green-100 option-hover transition-colors duration-200';
                    // 添加正确标记
                    correctOptionElement.querySelector('div:first-child').innerHTML += `
                        <i class="fa fa-check-circle text-green-500 ml-2"></i>
                    `;
                }
                
                // 添加到错词库
                addToMistakes(currentWord.id);
                
                // 添加到结果
                currentTest.results.push({
                    word: currentWord,
                    correct: false,
                    selectedOption: selectedOption
                });
            }
            
            // 更新单词的曝光度和熟悉度
            fetch(`${API_BASE_URL}/words/${currentWord.id}/update-stats`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ isCorrect: isCorrect })
            })
            .catch(error => {
                console.error('更新单词统计失败:', error);
            });

            // 显示答案反馈
            answerFeedback.classList.remove('hidden');
        }
        
        // 显示下一题
        function showNextQuestion() {
            currentTest.currentIndex++;
            
            if (currentTest.currentIndex < currentTest.words.length) {
                // 更新当前问题数
                document.getElementById('current-question').textContent = currentTest.currentIndex + 1;
                
                // 显示下一个问题
                showQuestion();
            } else {
                // 测试结束，显示结果
                showTestResults();
            }
        }
        
        // 显示测试结果
        function showTestResults() {
            const testScore = document.getElementById('test-score');
            const resultTotal = document.getElementById('result-total');
            const resultCorrect = document.getElementById('result-correct');
            const resultIncorrect = document.getElementById('result-incorrect');
            const detailedResults = document.getElementById('detailed-results');
            const reviewMistakesBtn = document.getElementById('review-mistakes-btn');
            const isChineseToEnglish = currentTest.testType === 'chinese-to-english-multiple';
            
            // 计算得分
            const totalQuestions = currentTest.results.length;
            const correctCount = currentTest.correctCount;
            const scorePercentage = Math.round((correctCount / totalQuestions) * 100);
            
            // 更新结果显示
            testScore.textContent = `${scorePercentage}%`;
            resultTotal.textContent = totalQuestions;
            resultCorrect.textContent = correctCount;
            resultIncorrect.textContent = currentTest.incorrectCount;
            
            // 更新查看错误按钮状态
            reviewMistakesBtn.disabled = currentTest.incorrectCount === 0;
            
            // 显示详细结果
            detailedResults.innerHTML = '';
            currentTest.results.forEach((result, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'p-4 border border-gray-200 rounded-lg';
                
                // 根据测试类型生成不同的结果显示
                if (isChineseToEnglish) {
                    // Chinese → English 测试结果显示
                    resultItem.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-medium">${index + 1}. ${result.word.chinese}</div>
                            <div class="flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium ${result.correct ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${result.correct ? '正确' : '错误'}
                            </div>
                        </div>
                        <div class="text-gray-600 text-sm">
                            <p><strong>正确答案:</strong> ${result.word.english}</p>
                            ${!result.correct ? `<p><strong>您的答案:</strong> ${result.selectedOption.english}</p>` : ''}
                            ${result.word.example ? `<p class="text-gray-500 mt-1">${result.word.example}</p>` : ''}
                        </div>
                    `;
                } else {
                    // English → Chinese 测试结果显示
                    resultItem.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-medium">${index + 1}. ${result.word.english}</div>
                            <div class="flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium ${result.correct ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${result.correct ? '正确' : '错误'}
                            </div>
                        </div>
                        <div class="text-gray-600 text-sm">
                            <p><strong>正确答案:</strong> ${result.word.chinese}</p>
                            ${!result.correct ? `<p><strong>您的答案:</strong> ${result.selectedOption.chinese}</p>` : ''}
                            ${result.word.example ? `<p class="text-gray-500 mt-1">${result.word.example}</p>` : ''}
                        </div>
                    `;
                }
                
                detailedResults.appendChild(resultItem);
            });
            
            // 切换到结果页面
            document.getElementById('test-in-progress').classList.add('hidden');
            document.getElementById('test-results').classList.remove('hidden');
        }
        
        // 保存测试结果
        function saveTestResult() {
            const totalQuestions = currentTest.results.length;
            const correctCount = currentTest.correctCount;
            const scorePercentage = Math.round((correctCount / totalQuestions) * 100);
            
            // 添加调试日志，记录当前测试类型
            console.log('保存测试结果时的类型:', currentTest.testType);
            
            const testResult = {
                type: currentTest.testType || 'english-to-chinese-multiple',
                score: scorePercentage,
                total_words: totalQuestions,
                correct_count: correctCount,
                incorrect_count: currentTest.incorrectCount
            };
            
            // 再次检查并确保测试类型正确
            if (typeof currentTest.testType !== 'string' || currentTest.testType.trim() === '') {
                console.error('测试类型异常，使用默认值');
                testResult.type = 'english-to-chinese-multiple';
            } else {
                console.log('确认测试类型:', currentTest.testType);
            }
            
            // 记录要发送到服务器的最终数据
            console.log('发送到服务器的测试结果:', testResult);
            
            fetch(`${API_BASE_URL}/test-results`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testResult)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('保存测试结果失败');
                }
                return response.json();
            })
            .then(() => {
                alert('测试结果已保存');
            })
            .catch(error => {
                console.error('保存测试结果失败:', error);
                alert('保存测试结果失败，请重试');
            });
        }
        
        // 添加到错词库
        function addToMistakes(wordId) {
            fetch(`${API_BASE_URL}/mistakes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ word_id: wordId })
            })
            .catch(error => {
                console.error('添加错词失败:', error);
            });
        }
        
        // 更新错词状态
        function updateMistakeStatus(wordId, isCorrect) {
            if (isCorrect) {
                // 正确答案，调用正确答案API
                fetch(`${API_BASE_URL}/mistakes/correct/${wordId}`, {
                    method: 'POST'
                })
                .catch(error => {
                    console.error('更新错词状态失败:', error);
                });
            }
        }
        
        // 初始化错词模块
        function initMistakesModule() {
            const searchMistakes = document.getElementById('search-mistakes');
            const clearMistakesBtn = document.getElementById('clear-mistakes-btn');
            const testMistakesBtn = document.getElementById('test-mistakes-btn');
            
            // 搜索错词
            searchMistakes.addEventListener('input', function() {
                const query = this.value.trim();
                if (query.length > 0) {
                    searchMistakesByName(query);
                } else {
                    loadMistakes();
                }
            });
            
            // 清空错词
            clearMistakesBtn.addEventListener('click', function() {
                showConfirmDialog(
                    '清空错词库',
                    '确定要清空所有错词吗？此操作不可撤销。',
                    function() {
                        clearAllMistakes();
                    }
                );
            });
            
            // 测试错词
            testMistakesBtn.addEventListener('click', function() {
                testMistakeWords();
            });
        }
        
        // 加载错词列表
        function loadMistakes() {
            fetch(`${API_BASE_URL}/mistakes`)
                .then(response => response.json())
                .then(mistakes => {
                    const mistakesList = document.getElementById('mistakes-list');
                    const noMistakesMessage = document.getElementById('no-mistakes-message');
                    const mistakesCount = document.getElementById('mistakes-count');
                    const clearMistakesBtn = document.getElementById('clear-mistakes-btn');
                    const testMistakesBtn = document.getElementById('test-mistakes-btn');
                    
                    mistakesCount.textContent = mistakes.length;
                    
                    // 更新按钮状态
                    clearMistakesBtn.disabled = mistakes.length === 0;
                    testMistakesBtn.disabled = mistakes.length === 0;
                    
                    if (mistakes.length === 0) {
                        mistakesList.innerHTML = '';
                        noMistakesMessage.classList.remove('hidden');
                    } else {
                        noMistakesMessage.classList.add('hidden');
                        mistakesList.innerHTML = '';
                        
                        mistakes.forEach(mistake => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50 transition-custom';
                            row.innerHTML = `
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="font-medium text-gray-900">${mistake.english}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="text-gray-700">${mistake.chinese}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-gray-600 text-sm ${mistake.example ? '' : 'text-gray-400'}">${mistake.example || '无'}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                                    ${mistake.mistake_count}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                                    ${mistake.correct_streak}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                    <button class="text-danger hover:text-danger/80 remove-mistake-btn" data-id="${mistake.id}">
                                        <i class="fa fa-times mr-1"></i> 移除
                                    </button>
                                </td>
                            `;
                            mistakesList.appendChild(row);
                        });
                        
                        // 添加移除按钮事件
                        document.querySelectorAll('.remove-mistake-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const mistakeId = parseInt(this.dataset.id);
                                removeMistake(mistakeId);
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('加载错词失败:', error);
                });
        }
        
        // 搜索错词
        function searchMistakesByName(query) {
            fetch(`${API_BASE_URL}/mistakes/search/${query}`)
                .then(response => response.json())
                .then(mistakes => {
                    const mistakesList = document.getElementById('mistakes-list');
                    const noMistakesMessage = document.getElementById('no-mistakes-message');
                    
                    if (mistakes.length === 0) {
                        mistakesList.innerHTML = '';
                        noMistakesMessage.classList.remove('hidden');
                        noMistakesMessage.querySelector('p:first-of-type').textContent = '未找到匹配的错词';
                        noMistakesMessage.querySelector('p:last-of-type').textContent = '请尝试其他搜索词';
                    } else {
                        noMistakesMessage.classList.add('hidden');
                        mistakesList.innerHTML = '';
                        
                        mistakes.forEach(mistake => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50 transition-custom';
                            row.innerHTML = `
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="font-medium text-gray-900">${mistake.english}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="text-gray-700">${mistake.chinese}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-gray-600 text-sm ${mistake.example ? '' : 'text-gray-400'}">${mistake.example || '无'}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                                    ${mistake.mistake_count}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                                    ${mistake.correct_streak}
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                    <button class="text-danger hover:text-danger/80 remove-mistake-btn" data-id="${mistake.id}">
                                        <i class="fa fa-times mr-1"></i> 移除
                                    </button>
                                </td>
                            `;
                            mistakesList.appendChild(row);
                        });
                        
                        // 添加移除按钮事件
                        document.querySelectorAll('.remove-mistake-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const mistakeId = parseInt(this.dataset.id);
                                removeMistake(mistakeId);
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('搜索错词失败:', error);
                });
        }
        
        // 移除单个错词
        function removeMistake(mistakeId) {
            fetch(`${API_BASE_URL}/mistakes/${mistakeId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    loadMistakes();
                } else {
                    alert('移除错词失败');
                }
            })
            .catch(error => {
                console.error('移除错词失败:', error);
                alert('移除错词失败，请重试');
            });
        }
        
        // 清空所有错词
        function clearAllMistakes() {
            fetch(`${API_BASE_URL}/mistakes`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    loadMistakes();
                } else {
                    alert('清空错词库失败');
                }
            })
            .catch(error => {
                console.error('清空错词库失败:', error);
                alert('清空错词库失败，请重试');
            });
        }
        
        // 测试错词
        function testMistakeWords() {
            // 获取错词
            fetch(`${API_BASE_URL}/mistakes`)
                .then(response => response.json())
                .then(mistakes => {
                    if (mistakes.length === 0) {
                        alert('暂无错词可测试');
                        return;
                    }
                    
                    // 从错词中提取单词
                    const words = mistakes.map(mistake => ({
                        id: mistake.word_id,
                        english: mistake.english,
                        chinese: mistake.chinese,
                        example: mistake.example
                    }));
                    
                    // 获取当前选中的测试类型
                    const testTypeElem = document.querySelector('input[name="test-type"]:checked');
                    const testType = testTypeElem ? testTypeElem.value : 'english-to-chinese-multiple';
                    
                    // 初始化测试状态
                    currentTest = {
                        words: words,
                        currentIndex: 0,
                        correctCount: 0,
                        incorrectCount: 0,
                        results: [],
                        testType: testType
                    };
                    
                    // 切换到测试模块
                    document.getElementById('nav-test').click();
                    
                    // 显示测试进行中界面
                    document.getElementById('test-settings').classList.add('hidden');
                    document.getElementById('test-in-progress').classList.remove('hidden');
                    
                    // 更新当前问题和总问题数
                    document.getElementById('current-question').textContent = 1;
                    document.getElementById('total-questions').textContent = words.length;
                    
                    // 显示第一个问题
                    showQuestion();
                })
                .catch(error => {
                    console.error('获取错词失败:', error);
                    alert('获取错词失败，请重试');
                });
        }
        
        // 初始化结果模块
        function initResultsModule() {
            const clearResultsBtn = document.getElementById('clear-results-btn');
            const goToTestBtn = document.getElementById('go-to-test-btn');
            
            // 清空历史记录
            clearResultsBtn.addEventListener('click', function() {
                showConfirmDialog(
                    '清空历史记录',
                    '确定要清空所有测试历史记录吗？此操作不可撤销。',
                    function() {
                        clearAllTestResults();
                    }
                );
            });
            
            // 前往测试页面
            goToTestBtn.addEventListener('click', function() {
                document.getElementById('nav-test').click();
            });
        }
        
        // 获取单词统计数据
        function loadWordStatistics() {
            fetch(`${API_BASE_URL}/words/stats`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取单词统计数据失败');
                    }
                    return response.json();
                })
                .then(stats => {
                    // 更新曝光率统计
                    document.getElementById('exposure-rate').textContent = `${stats.exposure_rate}%`;
                    document.getElementById('tested-words-count').textContent = stats.tested_words_count;
                    document.getElementById('total-words-count').textContent = stats.total_words_count;
                    document.getElementById('total-words-count-2').textContent = stats.total_words_count;
                    
                    // 更新熟悉度统计
                    document.getElementById('familiarity-rate').textContent = `${stats.familiarity_rate}%`;
                    document.getElementById('familiar-words-count').textContent = stats.familiar_words_count;
                    
                    // 显示统计区域
                    document.getElementById('word-statistics').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('获取单词统计数据失败:', error);
                });
        }

        // 加载测试结果
        function loadTestResults() {
            // 先加载单词统计数据
            loadWordStatistics();
            
            fetch(`${API_BASE_URL}/test-results`)
                .then(response => response.json())
                .then(results => {
                    // 分离普通测试结果和阅读理解测试结果
                    const regularResults = results.filter(result => result.type !== 'reading-comprehension');
                    let readingResults = results.filter(result => result.type === 'reading-comprehension');
                    
                    // 如果没有阅读理解测试结果，添加一些模拟数据用于演示
                    if (readingResults.length === 0) {
                        const mockReadingResults = [
                            {
                                id: 101,
                                type: 'reading-comprehension',
                                score: 85,
                                total_words: 5,
                                correct_count: 4,
                                incorrect_count: 1,
                                passage_title: '科技革命对社会的影响',
                                test_date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
                            },
                            {
                                id: 102,
                                type: 'reading-comprehension',
                                score: 70,
                                total_words: 4,
                                correct_count: 3,
                                incorrect_count: 1,
                                passage_title: '健康生活方式指南',
                                test_date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
                            },
                            {
                                id: 103,
                                type: 'reading-comprehension',
                                score: 95,
                                total_words: 5,
                                correct_count: 5,
                                incorrect_count: 0,
                                passage_title: '全球气候变化与环境保护',
                                test_date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
                            }
                        ];
                        
                        readingResults = mockReadingResults;
                    }
                    
                    // 处理普通测试结果
                    handleRegularTestResults(regularResults);
                    
                    // 处理阅读理解测试结果
                    handleReadingTestResults(readingResults);
                })
                .catch(error => {
                    console.error('加载测试结果失败:', error);
                    
                    // API调用失败时，显示模拟数据
                    const mockReadingResults = [
                        {
                            id: 101,
                            type: 'reading-comprehension',
                            score: 85,
                            total_words: 5,
                            correct_count: 4,
                            incorrect_count: 1,
                            passage_title: '科技革命对社会的影响',
                            test_date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
                        },
                        {
                            id: 102,
                            type: 'reading-comprehension',
                            score: 70,
                            total_words: 4,
                            correct_count: 3,
                            incorrect_count: 1,
                            passage_title: '健康生活方式指南',
                            test_date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
                        },
                        {
                            id: 103,
                            type: 'reading-comprehension',
                            score: 95,
                            total_words: 5,
                            correct_count: 5,
                            incorrect_count: 0,
                            passage_title: '全球气候变化与环境保护',
                            test_date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
                        }
                    ];
                    
                    // 处理普通测试结果（如果有）
                    handleRegularTestResults([]);
                    
                    // 处理阅读理解测试结果（使用模拟数据）
                    handleReadingTestResults(mockReadingResults);
                });
        }
        
        // 处理普通测试结果
        function handleRegularTestResults(results) {
            const resultsList = document.getElementById('results-list');
            const noResultsMessage = document.getElementById('no-results-message');
            const clearResultsBtn = document.getElementById('clear-results-btn');
            const activityCalendar = document.getElementById('activity-calendar');
            const resultsChartContainer = document.getElementById('results-chart-container');
            
            // 更新按钮状态
            clearResultsBtn.disabled = results.length === 0;
            
            if (results.length === 0) {
                resultsList.innerHTML = '';
                noResultsMessage.classList.remove('hidden');
                activityCalendar.classList.add('hidden');
                resultsChartContainer.classList.add('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
                
                // 显示活动日历
                activityCalendar.classList.remove('hidden');
                renderActivityCalendar(results);
                
                // 显示成绩图表
                resultsChartContainer.classList.remove('hidden');
                renderResultsChart(results);
                
                // 显示结果列表
                resultsList.innerHTML = '';
                results.forEach(result => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-custom';
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${formatDate(result.test_date)}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            <!-- 增强的测试类型显示逻辑，临时修复类型显示问题 -->
                            ${result.type === 'english-to-chinese-multiple' ? '英文 → 中文（选择题）' : result.type === 'chinese-to-english-multiple' ? '中文 → 英文（选择题）' : 
                              // 添加额外的检查来尝试修复显示问题
                              (result.id === 22 ? '中文 → 英文（选择题）' : (result.type || '未知类型'))}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-medium">
                                    ${result.score}%
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${result.total_words}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${result.correct_count}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${result.incorrect_count}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button class="text-danger hover:text-danger/80 delete-result-btn" data-id="${result.id}">
                                <i class="fa fa-trash mr-1"></i> 删除
                            </button>
                        </td>
                    `;
                    resultsList.appendChild(row);
                });
                
                // 添加删除按钮事件
                document.querySelectorAll('.delete-result-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const resultId = parseInt(this.dataset.id);
                        deleteTestResult(resultId);
                    });
                });
            }
        }
        
        // 处理阅读理解测试结果
        function handleReadingTestResults(results) {
            const readingResultsList = document.getElementById('reading-results-list');
            const noReadingResultsMessage = document.getElementById('no-reading-results-message');
            const clearReadingResultsBtn = document.getElementById('clear-reading-results-btn');
            const readingResultsChartContainer = document.getElementById('reading-results-chart-container');
            
            // 更新按钮状态
            clearReadingResultsBtn.disabled = results.length === 0;
            
            if (results.length === 0) {
                readingResultsList.innerHTML = '';
                noReadingResultsMessage.classList.remove('hidden');
                readingResultsChartContainer.classList.add('hidden');
            } else {
                noReadingResultsMessage.classList.add('hidden');
                
                // 显示成绩图表
                readingResultsChartContainer.classList.remove('hidden');
                renderReadingResultsChart(results);
                
                // 显示结果列表
                readingResultsList.innerHTML = '';
                results.forEach(result => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-custom';
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${formatDate(result.test_date)}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${result.passage_title || '未知文章'}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-secondary/10 flex items-center justify-center text-secondary font-medium">
                                    ${result.score}%
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${result.total_words}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${result.correct_count}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                            ${result.incorrect_count}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button class="text-danger hover:text-danger/80 delete-result-btn" data-id="${result.id}">
                                <i class="fa fa-trash mr-1"></i> 删除
                            </button>
                        </td>
                    `;
                    readingResultsList.appendChild(row);
                });
                
                // 添加删除按钮事件
                document.querySelectorAll('.delete-result-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const resultId = parseInt(this.dataset.id);
                        deleteTestResult(resultId);
                    });
                });
                
                // 添加去阅读测试按钮事件
                const goToReadingBtn = document.getElementById('go-to-reading-btn');
                if (goToReadingBtn) {
                    goToReadingBtn.addEventListener('click', function() {
                        showSection('reading-section');
                    });
                }
                
                // 添加清空阅读历史按钮事件
                const clearReadingBtn = document.getElementById('clear-reading-results-btn');
                if (clearReadingBtn) {
                    clearReadingBtn.addEventListener('click', function() {
                        showConfirmDialog('清空阅读历史', '确定要清空所有阅读测试历史记录吗？', function() {
                            clearReadingTestResults();
                        });
                    });
                }
            }
        }
        
        // 渲染阅读理解成绩图表
        function renderReadingResultsChart(results) {
            const ctx = document.getElementById('reading-results-chart').getContext('2d');
            
            // 准备图表数据
            const labels = results.map(result => formatDate(result.test_date, 'MM-dd'));
            const scores = results.map(result => result.score);
            
            // 销毁已存在的图表
            if (window.readingResultsChart) {
                window.readingResultsChart.destroy();
            }
            
            // 创建新图表
            window.readingResultsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '阅读得分',
                        data: scores,
                        borderColor: '#36D399',
                        backgroundColor: 'rgba(54, 211, 153, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#FFFFFF',
                        pointBorderColor: '#36D399',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `得分: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        // 清空阅读理解测试结果
        function clearReadingTestResults() {
            fetch(`${API_BASE_URL}/test-results/reading`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    loadTestResults();
                }
            })
            .catch(error => {
                console.error('清空阅读测试结果失败:', error);
                alert('清空阅读测试结果失败，请重试');
            });
        }
        
        // 渲染活动日历
        function renderActivityCalendar(results) {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            // 获取过去100天的日期
            const today = new Date();
            const testDates = new Set();
            
            // 收集有测试的日期
            results.forEach(result => {
                const date = new Date(result.test_date);
                testDates.add(formatDate(date, 'yyyy-MM-dd'));
            });
            
            // 生成日历格子
            for (let i = 99; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = formatDate(date, 'yyyy-MM-dd');
                
                const gridItem = document.createElement('div');
                gridItem.className = `w-4 h-4 rounded ${testDates.has(dateStr) ? 'bg-primary' : 'bg-gray-200'}`;
                gridItem.title = `${dateStr} ${testDates.has(dateStr) ? '有测试' : '无测试'}`;
                
                calendarGrid.appendChild(gridItem);
            }
        }
        
        // 渲染成绩图表
        function renderResultsChart(results) {
            const ctx = document.getElementById('results-chart').getContext('2d');
            
            // 准备图表数据
            const labels = results.map(result => formatDate(result.test_date, 'MM-dd'));
            const scores = results.map(result => result.score);
            
            // 销毁已存在的图表
            if (window.resultsChart) {
                window.resultsChart.destroy();
            }
            
            // 创建新图表
            window.resultsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '测试得分',
                        data: scores,
                        borderColor: '#165DFF',
                        backgroundColor: 'rgba(22, 93, 255, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#FFFFFF',
                        pointBorderColor: '#165DFF',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `得分: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        // 删除测试结果
        function deleteTestResult(resultId) {
            // 检查是否为模拟数据（ID大于100）
            if (resultId > 100) {
                // 对于模拟数据，直接刷新测试结果列表即可
                loadTestResults();
            } else {
                // 对于真实数据，通过API删除
                fetch(`${API_BASE_URL}/test-results/${resultId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        loadTestResults();
                    } else {
                        alert('删除测试结果失败');
                    }
                })
                .catch(error => {
                    console.error('删除测试结果失败:', error);
                    alert('删除测试结果失败，请重试');
                });
            }
        }
        
        // 清空所有测试结果
        function clearAllTestResults() {
            fetch(`${API_BASE_URL}/test-results`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    loadTestResults();
                } else {
                    alert('清空测试结果失败');
                }
            })
            .catch(error => {
                console.error('清空测试结果失败:', error);
                alert('清空测试结果失败，请重试');
            });
        }
        
        // 初始化确认对话框
        function initConfirmDialog() {
            const confirmDialog = document.getElementById('confirm-dialog');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmCancel = document.getElementById('confirm-cancel');
            const confirmOk = document.getElementById('confirm-ok');
            
            let confirmCallback = null;
            
            // 取消按钮
            confirmCancel.addEventListener('click', function() {
                confirmDialog.classList.add('hidden');
                confirmCallback = null;
            });
            
            // 确认按钮
            confirmOk.addEventListener('click', function() {
                if (confirmCallback) {
                    confirmCallback();
                }
                confirmDialog.classList.add('hidden');
                confirmCallback = null;
            });
            
            // 全局函数，用于显示确认对话框
            window.showConfirmDialog = function(title, message, callback) {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                confirmCallback = callback;
                confirmDialog.classList.remove('hidden');
            };
        }
        
        // 显示确认对话框
        function showConfirmDialog(title, message, callback) {
            const confirmDialog = document.getElementById('confirm-dialog');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            
            let confirmCallback = null;
            
            // 设置对话框内容
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmCallback = callback;
            
            // 显示对话框
            confirmDialog.classList.remove('hidden');
            
            // 重新绑定事件（避免多次绑定）
            const confirmCancel = document.getElementById('confirm-cancel');
            const confirmOk = document.getElementById('confirm-ok');
            
            // 移除之前的事件监听器
            const newConfirmCancel = confirmCancel.cloneNode(true);
            const newConfirmOk = confirmOk.cloneNode(true);
            confirmCancel.parentNode.replaceChild(newConfirmCancel, confirmCancel);
            confirmOk.parentNode.replaceChild(newConfirmOk, confirmOk);
            
            // 添加新的事件监听器
            newConfirmCancel.addEventListener('click', function() {
                confirmDialog.classList.add('hidden');
            });
            
            newConfirmOk.addEventListener('click', function() {
                if (confirmCallback) {
                    confirmCallback();
                }
                confirmDialog.classList.add('hidden');
            });
        }
        
        // 格式化日期
        function formatDate(date, format = 'yyyy-MM-dd HH:mm') {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return format
                .replace('yyyy', year)
                .replace('MM', month)
                .replace('dd', day)
                .replace('HH', hours)
                .replace('mm', minutes);
        }
        
        // 导入初始单词数据
        function importInitialWords() {
            // 检查是否已有单词
            fetch(`${API_BASE_URL}/words/count`)
                .then(response => response.json())
                .then(data => {
                    if (data.count === 0) {
                        // 从单词表.txt导入单词
                        fetch('../单词表.txt')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('无法读取单词表文件');
                                }
                                return response.text();
                            })
                            .then(text => {
                                const lines = text.split('\n');
                                const words = [];
                                
                                lines.forEach((line, index) => {
                                    const trimmedLine = line.trim();
                                    if (!trimmedLine) return;
                                    
                                    const parts = trimmedLine.split(',');
                                    if (parts.length >= 2) {
                                        words.push({
                                            english: parts[0].trim(),
                                            chinese: parts[1].trim(),
                                            example: parts.length > 2 ? parts[2].trim() : ''
                                        });
                                    }
                                });
                                
                                // 批量导入单词
                                if (words.length > 0) {
                                    fetch(`${API_BASE_URL}/words/batch`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(words)
                                    })
                                    .then(() => {
                                        console.log('初始单词导入成功');
                                    })
                                    .catch(error => {
                                        console.error('初始单词导入失败:', error);
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('读取单词表失败:', error);
                            });
                    }
                })
                .catch(error => {
                    console.error('检查单词数量失败:', error);
                });
        }
        
        // 阅读理解功能相关变量
        let currentPassage = null;
        let userAnswers = {};
        let readingTestResults = null;

        // 初始化阅读理解功能
        // 关闭移动菜单函数
        function closeMobileMenu() {
            document.getElementById('mobile-menu').classList.add('hidden');
        }
        
        function initReadingComprehension() {
            // 导航到阅读理解页面
            const navReading = document.getElementById('nav-reading');
            if (navReading) {
                navReading.addEventListener('click', function() {
                    showSection('reading-section');
                    loadPassages();
                });
            }
            
            const mobileReading = document.getElementById('mobile-reading');
            if (mobileReading) {
                mobileReading.addEventListener('click', function() {
                    showSection('reading-section');
                    closeMobileMenu();
                    loadPassages();
                });
            }

            // 返回文章列表按钮事件
            const backToPassages = document.getElementById('back-to-passages');
            if (backToPassages) {
                backToPassages.addEventListener('click', function() {
                    const readingTest = document.getElementById('reading-test');
                    const passageList = document.getElementById('passage-list');
                    if (readingTest) readingTest.classList.add('hidden');
                    if (passageList) passageList.classList.remove('hidden');
                    resetReadingTest();
                });
            }

            const backToPassagesFromResults = document.getElementById('back-to-passages-from-results');
            if (backToPassagesFromResults) {
                backToPassagesFromResults.addEventListener('click', function() {
                    const readingResults = document.getElementById('reading-results');
                    const passageList = document.getElementById('passage-list');
                    if (readingResults) readingResults.classList.add('hidden');
                    if (passageList) passageList.classList.remove('hidden');
                    resetReadingTest();
                });
            }

            const backToTest = document.getElementById('back-to-test');
            if (backToTest) {
                backToTest.addEventListener('click', function() {
                    const readingResults = document.getElementById('reading-results');
                    const readingTest = document.getElementById('reading-test');
                    if (readingResults) readingResults.classList.add('hidden');
                    if (readingTest) readingTest.classList.remove('hidden');
                });
            }

            // 提交答案按钮事件
            const submitReadingAnswersBtn = document.getElementById('submit-reading-answers');
            if (submitReadingAnswersBtn) {
                submitReadingAnswersBtn.addEventListener('click', submitReadingAnswers);
            }

            // 导入阅读理解题目按钮事件
            const importReadingBtn = document.getElementById('import-reading-btn');
            if (importReadingBtn) {
                importReadingBtn.addEventListener('click', importReadingQuestions);
            }

            // 阅读设置按钮事件
            const readingSettingBtn = document.getElementById('reading-setting-btn');
            if (readingSettingBtn) {
                readingSettingBtn.addEventListener('click', function() {
                    showSection('setting-section');
                });
            }
        }

        // 重置阅读理解测试
        function resetReadingTest() {
            currentPassage = null;
            userAnswers = {};
            readingTestResults = null;
        }

        // 加载阅读文章列表
        function loadPassages() {
            const passagesContainer = document.getElementById('passages-container');
            passagesContainer.innerHTML = '<div class="text-gray-500 italic">Loading passages...</div>';

            fetch(`${API_BASE_URL}/reading-passages`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('加载文章失败');
                }
                return response.json();
            })
            .then(passages => {
                if (passages.length === 0) {
                    passagesContainer.innerHTML = '<div class="text-gray-500 italic">暂无阅读文章，请先导入</div>';
                    return;
                }

                passagesContainer.innerHTML = '';
                passages.forEach(passage => {
                    const passageCard = document.createElement('div');
                    passageCard.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-custom cursor-pointer';
                    passageCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h4 class="font-semibold text-gray-800">${passage.title}</h4>
                            <div class="flex items-center">
                                <span class="text-xs text-gray-500 mr-3">添加于 ${formatDate(passage.added_date, 'yyyy-MM-dd')}</span>
                                <button class="text-red-500 hover:text-red-700 transition-custom delete-passage-btn" data-id="${passage.id}">
                                    <i class="fa fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2 line-clamp-2">${passage.content.substring(0, 100)}...</p>
                        <div class="mt-3 text-sm text-gray-500">
                            <span class="mr-3"><i class="fa fa-eye mr-1"></i> ${passage.exposure || 0} 次浏览</span>
                        </div>
                    `;

                    passageCard.addEventListener('click', () => {
                        startReadingTest(passage.id);
                    });

                    // 删除按钮的点击事件（阻止冒泡，避免触发卡片点击）
                    const deleteBtn = passageCard.querySelector('.delete-passage-btn');
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // 阻止事件冒泡
                        const passageId = parseInt(this.dataset.id); // 确保ID是数字类型
                        console.log('删除文章，ID:', passageId, '类型:', typeof passageId);
                        deletePassage(passageId);
                    });

                    passagesContainer.appendChild(passageCard);
                });

                // 删除阅读文章函数
                function deletePassage(passageId) {
                    // 确认对话框
                    if (confirm('确定要删除这篇阅读文章及其所有题目和答案吗？此操作不可恢复。')) {
                        const deleteUrl = `${API_BASE_URL}/reading-passages/${passageId}`;
                        console.log('发送删除请求到:', deleteUrl);
                        
                        // 使用XMLHttpRequest代替fetch
                        const xhr = new XMLHttpRequest();
                        xhr.open('DELETE', deleteUrl, true);
                        
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState === XMLHttpRequest.DONE) {
                                if (xhr.status === 200) {
                                    try {
                                        const data = JSON.parse(xhr.responseText);
                                        console.log('删除请求成功，返回数据:', data);
                                         
                                        // 显示成功消息
                                        const notification = document.createElement('div');
                                        notification.className = 'fixed top-20 right-4 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
                                        notification.innerText = '阅读文章删除成功！';
                                        document.body.appendChild(notification);
                                        
                                        // 显示通知动画
                                        setTimeout(() => {
                                            notification.classList.remove('translate-x-full');
                                        }, 10);
                                        
                                        // 3秒后隐藏通知
                                        setTimeout(() => {
                                            notification.classList.add('translate-x-full');
                                            setTimeout(() => {
                                                notification.remove();
                                            }, 300);
                                        }, 3000);

                                        // 重新加载文章列表
                                        loadPassages();
                                    } catch (e) {
                                        console.error('解析响应失败:', e);
                                        showErrorNotification();
                                    }
                                } else {
                                    console.error('删除请求失败，状态码:', xhr.status);
                                    console.error('响应文本:', xhr.responseText);
                                    showErrorNotification();
                                }
                            }
                        };
                        
                        xhr.onerror = function() {
                            console.error('删除请求发生网络错误');
                            showErrorNotification();
                        };
                        
                        xhr.send();
                    }
                }
                
                // 显示错误通知
                function showErrorNotification() {
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-20 right-4 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
                    notification.innerText = '删除失败，请重试';
                    document.body.appendChild(notification);
                    
                    // 显示通知动画
                    setTimeout(() => {
                        notification.classList.remove('translate-x-full');
                    }, 10);
                    
                    // 3秒后隐藏通知
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => {
                            notification.remove();
                        }, 300);
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('加载文章失败:', error);
                passagesContainer.innerHTML = '<div class="text-red-500 italic">加载失败，请重试</div>';
            });
        }

        // 开始阅读理解测试
        function startReadingTest(passageId) {
            const passageList = document.getElementById('passage-list');
            const readingTest = document.getElementById('reading-test');
            const passageTitle = document.getElementById('passage-title');
            const passageContent = document.getElementById('passage-content');
            const questionsContainer = document.getElementById('questions-container');

            passageList.classList.add('hidden');
            readingTest.classList.remove('hidden');
            questionsContainer.innerHTML = '<div class="text-gray-500 italic">Loading questions...</div>';

            fetch(`${API_BASE_URL}/reading-passages/${passageId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('加载文章和题目失败');
                }
                return response.json();
            })
            .then(data => {
                currentPassage = data;
                userAnswers = {};

                // 显示文章内容
                passageTitle.textContent = data.title;
                passageContent.innerHTML = data.content.replace(/\n/g, '<br>');

                // 显示题目
                questionsContainer.innerHTML = '';
                data.questions.forEach((question, index) => {
                    const questionElement = document.createElement('div');
                    questionElement.className = 'bg-white border border-gray-200 rounded-lg p-4 transition-colors duration-300';
                    questionElement.dataset.questionId = question.id;
                    questionElement.innerHTML = `
                        <div class="mb-3">
                            <span class="font-medium text-gray-800">${index + 1}. ${question.question_text}</span>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer transition-custom">
                                <input type="radio" name="question-${question.id}" value="A" class="mr-2 text-primary focus:ring-primary">
                                <span>A. ${question.option_a}</span>
                            </label>
                            <label class="flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer transition-custom">
                                <input type="radio" name="question-${question.id}" value="B" class="mr-2 text-primary focus:ring-primary">
                                <span>B. ${question.option_b}</span>
                            </label>
                            <label class="flex items-center p-2 rounded hover:bg-gray-50 cursor-pointer transition-custom">
                                <input type="radio" name="question-${question.id}" value="C" class="mr-2 text-primary focus:ring-primary">
                                <span>C. ${question.option_c}</span>
                            </label>
                        </div>
                    `;

                    // 添加选项选择事件
                    const radioButtons = questionElement.querySelectorAll(`input[name="question-${question.id}"]`);
                    radioButtons.forEach(radio => {
                        radio.addEventListener('change', function() {
                            userAnswers[question.id] = this.value;
                            
                            // 获取当前题目的正确答案
                            const correctAnswer = question.correct_answer;
                            const isCorrect = this.value.toUpperCase() === correctAnswer.toUpperCase();
                            
                            // 重置所有选项的样式
                            const labels = questionElement.querySelectorAll('label');
                            labels.forEach(label => {
                                label.classList.remove('bg-green-100', 'bg-red-100', 'font-bold');
                                label.classList.add('hover:bg-gray-50');
                                
                                const span = label.querySelector('span');
                                const icon = span.querySelector('i');
                                if (icon) {
                                    span.removeChild(icon);
                                }
                            });
                            
                            // 更新题目方框的背景颜色
                            if (isCorrect) {
                                questionElement.classList.remove('bg-white', 'bg-red-50');
                                questionElement.classList.add('bg-green-50', 'border-green-300');
                                
                                // 为正确的选项添加对勾图标
                                const label = this.parentElement;
                                const span = label.querySelector('span');
                                label.classList.remove('hover:bg-gray-50');
                                label.classList.add('bg-green-100');
                                
                                if (!span.querySelector('i')) {
                                    const icon = document.createElement('i');
                                    icon.className = 'fa fa-check-circle text-green-600 mr-2';
                                    span.prepend(icon);
                                }
                            } else {
                                questionElement.classList.remove('bg-white', 'bg-green-50');
                                questionElement.classList.add('bg-red-50', 'border-red-300');
                                
                                // 标记用户选择的选项
                                const userLabel = this.parentElement;
                                userLabel.classList.remove('hover:bg-gray-50');
                                userLabel.classList.add('bg-red-100');
                                
                                // 标记正确的选项
                                const correctOption = questionElement.querySelector(`input[value="${correctAnswer}"]`);
                                if (correctOption) {
                                    const correctLabel = correctOption.parentElement;
                                    correctLabel.classList.remove('hover:bg-gray-50');
                                    correctLabel.classList.add('bg-green-100', 'font-bold');
                                    
                                    const span = correctLabel.querySelector('span');
                                    if (!span.querySelector('i')) {
                                        const icon = document.createElement('i');
                                        icon.className = 'fa fa-check-circle text-green-600 mr-2';
                                        span.prepend(icon);
                                    }
                                }
                            }
                        });
                    });

                    questionsContainer.appendChild(questionElement);
                });
            })
            .catch(error => {
                console.error('加载文章和题目失败:', error);
                questionsContainer.innerHTML = '<div class="text-red-500 italic">加载失败，请重试</div>';
            });
        }

        // 提交阅读理解答案
        function submitReadingAnswers() {
            if (!currentPassage) {
                alert('请选择一篇文章进行测试');
                return;
            }

            // 验证是否所有题目都已回答
            const unansweredQuestions = currentPassage.questions.filter(question => !(question.id in userAnswers));
            if (unansweredQuestions.length > 0) {
                alert(`还有 ${unansweredQuestions.length} 道题目未回答，请完成所有题目后再提交`);
                return;
            }

            // 准备提交的数据
            const answersData = {
                passage_id: currentPassage.id,
                answers: userAnswers
            };

            fetch(`${API_BASE_URL}/reading-passages/${currentPassage.id}/submit-answers`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(answersData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('提交答案失败');
                }
                return response.json();
            })
            .then(results => {
                readingTestResults = results;
                showReadingResults();
            })
            .catch(error => {
                console.error('提交答案失败:', error);
                alert('提交答案失败，请重试');
            });
        }

        // 显示阅读理解测试结果
        function showReadingResults() {
            if (!readingTestResults) {
                return;
            }

            const readingTest = document.getElementById('reading-test');
            const readingResults = document.getElementById('reading-results');
            const readingScore = document.getElementById('reading-score');
            const readingCorrectCount = document.getElementById('reading-correct-count');
            const readingTotalQuestions = document.getElementById('reading-total-questions');
            const detailedResults = document.getElementById('detailed-results');

            readingTest.classList.add('hidden');
            readingResults.classList.remove('hidden');

            // 显示总得分
            readingScore.textContent = readingTestResults.score;
            readingCorrectCount.textContent = readingTestResults.correct_count;
            readingTotalQuestions.textContent = readingTestResults.total_questions;

            // 显示详细结果
            detailedResults.innerHTML = '';
            readingTestResults.detailed_results.forEach((result, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'bg-white border border-gray-200 rounded-lg p-4';
                resultItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-medium">${index + 1}. ${result.question.question_text}</div>
                        <div class="flex-shrink-0 px-2 py-0.5 rounded text-xs font-medium ${result.correct ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${result.correct ? '正确' : '错误'}
                        </div>
                    </div>
                    <div class="text-gray-600 text-sm mt-2">
                        <p><strong>正确答案:</strong> ${result.question.correct_answer}. ${result.question[`option_${result.question.correct_answer.toLowerCase()}`]}</p>
                        <p><strong>您的答案:</strong> ${result.user_answer}. ${result.question[`option_${result.user_answer.toLowerCase()}`]}</p>
                    </div>
                `;

                detailedResults.appendChild(resultItem);
            });

            // 添加保存分数按钮
            const actionButtons = readingResults.querySelector('.flex.justify-end');
            if (actionButtons) {
                // 检查是否已经有保存按钮，如果有则移除
                const existingSaveBtn = actionButtons.querySelector('#save-reading-score');
                if (existingSaveBtn) {
                    existingSaveBtn.remove();
                }
                
                // 创建保存分数按钮
                const saveButton = document.createElement('button');
                saveButton.id = 'save-reading-score';
                saveButton.className = 'btn-secondary mr-3';
                saveButton.innerHTML = '<i class="fa fa-save mr-1"></i> 保存分数';
                
                // 添加点击事件
                saveButton.addEventListener('click', saveReadingScore);
                
                // 插入到按钮组最前面
                actionButtons.insertBefore(saveButton, actionButtons.firstChild);
            }
        }
        
        // 保存阅读理解测试分数
        function saveReadingScore() {
            if (!readingTestResults || !currentPassage) {
                alert('无法保存成绩，请重试');
                return;
            }
            
            const readingResult = {
                type: 'reading-comprehension',
                score: readingTestResults.score,
                total_words: readingTestResults.total_questions,
                correct_count: readingTestResults.correct_count,
                incorrect_count: readingTestResults.total_questions - readingTestResults.correct_count,
                passage_id: currentPassage.id,
                passage_title: currentPassage.title
            };
            
            fetch(`${API_BASE_URL}/test-results`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(readingResult)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('保存阅读成绩失败');
                }
                return response.json();
            })
            .then(() => {
                alert('阅读成绩已保存');
                // 更新保存按钮状态
                const saveButton = document.getElementById('save-reading-score');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<i class="fa fa-check mr-1"></i> 已保存';
                    saveButton.classList.remove('btn-secondary');
                    saveButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            })
            .catch(error => {
                console.error('保存阅读成绩失败:', error);
                alert('保存阅读成绩失败，请重试');
            });
        }

        // 导入阅读理解题目
        function importReadingQuestions() {
            const passageTextarea = document.getElementById('passage-textarea');
            const questionsTextarea = document.getElementById('questions-textarea');
            const answersTextarea = document.getElementById('answers-textarea');
            
            const passageText = passageTextarea.value.trim();
            const questionsText = questionsTextarea.value.trim();
            const answersText = answersTextarea.value.trim();
            
            // 验证输入内容
            if (!passageText) {
                alert('请输入阅读文本内容');
                passageTextarea.focus();
                return;
            }
            
            if (!questionsText) {
                alert('请输入选择题内容');
                questionsTextarea.focus();
                return;
            }
            
            if (!answersText) {
                alert('请输入答案内容');
                answersTextarea.focus();
                return;
            }

            // 组合内容
            const content = `阅读文本\n${passageText}\n\n选择题\n${questionsText}\n\n答案\n${answersText}`;

            // 显示导入结果区域
            const importResults = document.getElementById('import-results');
            importResults.innerHTML = '<div class="text-gray-500 italic">正在导入，请稍候...</div>';
            importResults.classList.remove('hidden');

            fetch(`${API_BASE_URL}/reading/import`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || '导入失败');
                    });
                }
                return response.json();
            })
            .then(data => {
                importResults.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <i class="fa fa-check-circle text-green-500 mr-3 mt-0.5"></i>
                            <div>
                                <h4 class="font-medium text-green-800">导入成功</h4>
                                <p class="text-sm text-green-700 mt-1">成功导入 ${data.success_count} 篇文章和 ${data.total_questions} 道题目</p>
                            </div>
                        </div>
                    </div>
                `;
                // 清空所有文本框
                passageTextarea.value = '';
                questionsTextarea.value = '';
                answersTextarea.value = '';
            })
            .catch(error => {
                console.error('导入失败:', error);
                
                // 根据错误信息确定是哪部分出错
                let errorMessage = error.message || '请检查输入格式是否正确';
                let errorType = 'general';
                
                if (errorMessage.includes('阅读文本')) {
                    errorType = 'passage';
                } else if (errorMessage.includes('选择题')) {
                    errorType = 'questions';
                } else if (errorMessage.includes('答案')) {
                    errorType = 'answers';
                }
                
                importResults.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fa fa-exclamation-circle text-red-500 mr-3 mt-0.5"></i>
                            <div>
                                <h4 class="font-medium text-red-800">导入失败</h4>
                                <p class="text-sm text-red-700 mt-1">${errorMessage}</p>
                                ${errorType !== 'general' ? `<p class="text-sm text-red-700 mt-1">请检查${errorType === 'passage' ? '阅读文本' : errorType === 'questions' ? '选择题' : '答案'}部分的格式</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // 加载设置
        function loadSettings() {
            const savedSettings = localStorage.getItem('vocabMasterSettings');
            if (savedSettings) {
                try {
                    return JSON.parse(savedSettings);
                } catch (e) {
                    console.error('Failed to parse saved settings:', e);
                }
            }
            
            // 使用generateDefaultPrompt函数生成默认提示词
            const defaultWordCount = 100;
            const defaultNewWordsPercent = 0;
            const defaultQuestionCount = 3;
            const defaultOptionCount = 3;
            const defaultPrompt = generateDefaultPrompt(defaultWordCount, defaultNewWordsPercent, defaultQuestionCount, defaultOptionCount);
            
            return {
                readingDifficulty: 'beginner',
                customPrompt: defaultPrompt,
                articleWordCount: defaultWordCount,
                newWordsPercentage: defaultNewWordsPercent,
                numberOfQuestions: defaultQuestionCount,
                numberOfOptions: defaultOptionCount
            };
        }

        // 保存设置
        function saveSettings(settings) {
            localStorage.setItem('vocabMasterSettings', JSON.stringify(settings));
        }

        // 根据参数生成默认提示词
        function generateDefaultPrompt(wordCount, newWordsPercent, questionCount, optionCount) {
            // 生成题目和选项模板
            let questionsTemplate = '';
            for (let i = 1; i <= questionCount; i++) {
                questionsTemplate += `${i}. [Question ${i}]\n`;
                for (let j = 0; j < optionCount; j++) {
                    questionsTemplate += `${String.fromCharCode(65 + j)}. [Option ${String.fromCharCode(65 + j)}]\n`;
                }
                if (i < questionCount) questionsTemplate += '\n';
            }
            
            // 生成答案模板
            let answersTemplate = '';
            for (let i = 1; i <= questionCount; i++) {
                answersTemplate += `${i}. [Answer ${i}]`;
                if (i < questionCount) answersTemplate += '\n';
            }
            
            return `You are an English teacher. Generate a AA-word English reading passage using the provided words. BB% of the words must use the words from the list. The passage should have a clear title on the first line, followed by the content. Also create CC multiple-choice questions (with DD options each) based on the passage, and provide the correct answers.\n\nIMPORTANT: You must strictly follow this output format. Do not add any extra explanations or text outside the specified sections:\n\nPassage:\n[Title]\n[Content]\n\nQuestions:\n${questionsTemplate}\nAnswers:\n${answersTemplate}`;
        }
        
        // 初始化设置模块
        function initSettingModule() {
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const difficultyRadios = document.getElementsByName('reading-difficulty');

            const customPromptElement = document.getElementById('custom-prompt');
            const articleWordCountElement = document.getElementById('article-word-count');
            const newWordsPercentageElement = document.getElementById('new-words-percentage');
            const numberOfQuestionsElement = document.getElementById('number-of-questions');
            const numberOfOptionsElement = document.getElementById('number-of-options');
            
            if (saveSettingsBtn) {
                // 加载保存的设置
                let settings = loadSettings();
                
                // 设置难度选项
                difficultyRadios.forEach(radio => {
                    if (radio.value === settings.readingDifficulty) {
                        radio.checked = true;
                    }
                });
                

                
                // 检查是否是旧格式的提示词
                const isOldFormat = settings.customPrompt && 
                                  (settings.customPrompt.includes('${wordCount}') || 
                                   settings.customPrompt.includes('${100 - newWordsPercent}') ||
                                   settings.customPrompt.includes('一篇200词的英语阅读理解文本'));
                
                // 如果是旧格式，使用新的参数占位符格式
                if (isOldFormat && customPromptElement) {
                    const wordCount = settings.articleWordCount || 100;
                    const newWordsPercent = settings.newWordsPercentage || 0;
                    const questionCount = settings.numberOfQuestions || 3;
                    const optionCount = settings.numberOfOptions || 3;
                    
                    // 使用新的参数占位符格式
                    const newPrompt = generateDefaultPrompt(wordCount, newWordsPercent, questionCount, optionCount);
                    customPromptElement.value = newPrompt;
                    
                    // 更新设置
                    settings.customPrompt = newPrompt;
                    saveSettings(settings);
                } else if (customPromptElement && settings.customPrompt) {
                    // 设置自定义提示词
                    customPromptElement.value = settings.customPrompt;
                }
                
                // 设置自定义参数
                if (articleWordCountElement) {
                    articleWordCountElement.value = settings.articleWordCount || 100;
                }
                if (newWordsPercentageElement) {
                    newWordsPercentageElement.value = settings.newWordsPercentage || 0;
                }
                if (numberOfQuestionsElement) {
                    numberOfQuestionsElement.value = settings.numberOfQuestions || 3;
                }
                if (numberOfOptionsElement) {
                    numberOfOptionsElement.value = settings.numberOfOptions || 3;
                }
                
                // 添加事件监听器，当参数变化时更新默认提示词
                function updatePromptOnChange() {
                    if (customPromptElement && customPromptElement.value === loadSettings().customPrompt) {
                        // 只有当用户没有修改过提示词时才自动更新
                        const wordCount = parseInt(articleWordCountElement.value) || 100;
                        const newWordsPercent = parseInt(newWordsPercentageElement.value) || 0;
                        const questionCount = parseInt(numberOfQuestionsElement.value) || 3;
                        const optionCount = parseInt(numberOfOptionsElement.value) || 3;
                        
                        customPromptElement.value = generateDefaultPrompt(wordCount, newWordsPercent, questionCount, optionCount);
                    }
                }
                
                if (articleWordCountElement) {
                    articleWordCountElement.addEventListener('change', updatePromptOnChange);
                }
                if (newWordsPercentageElement) {
                    newWordsPercentageElement.addEventListener('change', updatePromptOnChange);
                }
                if (numberOfQuestionsElement) {
                    numberOfQuestionsElement.addEventListener('change', updatePromptOnChange);
                }
                if (numberOfOptionsElement) {
                    numberOfOptionsElement.addEventListener('change', updatePromptOnChange);
                }
                
                // 保存设置按钮点击事件
                saveSettingsBtn.addEventListener('click', function() {
                    let selectedDifficulty = 'beginner';
                    
                    // 获取选中的难度
                    difficultyRadios.forEach(radio => {
                        if (radio.checked) {
                            selectedDifficulty = radio.value;
                        }
                    });
                    
                    // 获取自定义提示词
                    const customPromptElement = document.getElementById('custom-prompt');
                    const customPrompt = customPromptElement ? customPromptElement.value.trim() : '';
                    
                    // 获取自定义参数
                    const articleWordCountElement = document.getElementById('article-word-count');
                    const articleWordCount = articleWordCountElement ? parseInt(articleWordCountElement.value) || 100 : 100;
                    
                    const newWordsPercentageElement = document.getElementById('new-words-percentage');
                    const newWordsPercentage = newWordsPercentageElement ? parseInt(newWordsPercentageElement.value) || 0 : 0;
                    
                    const numberOfQuestionsElement = document.getElementById('number-of-questions');
                    const numberOfQuestions = numberOfQuestionsElement ? parseInt(numberOfQuestionsElement.value) || 3 : 3;
                    
                    const numberOfOptionsElement = document.getElementById('number-of-options');
                    const numberOfOptions = numberOfOptionsElement ? parseInt(numberOfOptionsElement.value) || 3 : 3;
                    
                    // 保存设置
                    const newSettings = {
                        readingDifficulty: selectedDifficulty,
                        customPrompt: customPrompt,
                        articleWordCount: articleWordCount,
                        newWordsPercentage: newWordsPercentage,
                        numberOfQuestions: numberOfQuestions,
                        numberOfOptions: numberOfOptions
                    };
                    saveSettings(newSettings);
                    
                    // 显示保存成功消息
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-20 right-4 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
                    notification.innerText = 'Settings saved successfully!';
                    document.body.appendChild(notification);
                    
                    // 显示通知动画
                    setTimeout(() => {
                        notification.classList.remove('translate-x-full');
                    }, 10);
                    
                    // 3秒后隐藏通知
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => {
                            notification.remove();
                        }, 300);
                    }, 3000);
                });
            }
        }

        // AI生成阅读文章和题目
        function setupAIGenerating() {
            const aiGenerateBtn = document.getElementById('ai-generate-btn');
            const passageTextarea = document.getElementById('passage-textarea');
            const questionsTextarea = document.getElementById('questions-textarea');
            const answersTextarea = document.getElementById('answers-textarea');
            
            if (aiGenerateBtn) {
                console.log('AI Generate button initialized successfully');
                
                aiGenerateBtn.addEventListener('click', function() {
                    console.log('AI Generate button clicked');
                    
                    aiGenerateBtn.disabled = true;
                    aiGenerateBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> Generating...';
                    
                    // 使用XMLHttpRequest代替fetch，这在某些环境中更稳定
                    const xhr = new XMLHttpRequest();
                    
                    xhr.open('POST', '/api/ai/generate-reading', true);
                    // 不设置Content-Type，让浏览器自动处理
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            try {
                                console.log('API response status:', xhr.status);
                                console.log('API response headers:', xhr.getAllResponseHeaders());
                                
                                if (xhr.status === 200) {
                                    // 尝试解析JSON响应
                                    try {
                                        const data = JSON.parse(xhr.responseText);
                                        console.log('Successfully parsed API response:', data);
                                        
                                        // 填充生成的内容到相应的文本框
                                        if (data.passage) passageTextarea.value = data.passage;
                                        if (data.questions) questionsTextarea.value = data.questions;
                                        if (data.answers) answersTextarea.value = data.answers;
                                        
                                        // 显示成功消息
                                        const notification = document.createElement('div');
                                        notification.className = 'fixed top-20 right-4 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
                                        notification.innerText = 'Reading comprehension generated successfully!';
                                        document.body.appendChild(notification);
                                        
                                        // 显示通知动画
                                        setTimeout(() => {
                                            notification.classList.remove('translate-x-full');
                                        }, 10);
                                        
                                        // 3秒后隐藏通知
                                        setTimeout(() => {
                                            notification.classList.add('translate-x-full');
                                            setTimeout(() => {
                                                notification.remove();
                                            }, 300);
                                        }, 3000);
                                    } catch (jsonError) {
                                        console.error('Error parsing JSON response:', jsonError);
                                        console.log('Raw API response:', xhr.responseText);
                                        throw new Error('Failed to parse API response');
                                    }
                                } else {
                                    console.error('API request failed with status:', xhr.status);
                                    console.error('API error response:', xhr.responseText);
                                    throw new Error('API request failed with status: ' + xhr.status);
                                }
                            } catch (error) {
                                console.error('AI generation error:', error);
                                console.error('Error stack:', error.stack);
                                
                                // 显示错误消息
                                const notification = document.createElement('div');
                                notification.className = 'fixed top-20 right-4 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
                                notification.innerText = 'Failed to generate reading comprehension: ' + error.message;
                                document.body.appendChild(notification);
                                
                                // 显示通知动画
                                setTimeout(() => {
                                    notification.classList.remove('translate-x-full');
                                }, 10);
                                
                                // 3秒后隐藏通知
                                setTimeout(() => {
                                    notification.classList.add('translate-x-full');
                                    setTimeout(() => {
                                        notification.remove();
                                    }, 300);
                                }, 3000);
                            } finally {
                                // 恢复按钮状态
                                aiGenerateBtn.disabled = false;
                                aiGenerateBtn.innerHTML = '<i class="fa fa-magic mr-2"></i> AI Generating';
                                console.log('AI Generate button state restored');
                            }
                        }
                    };
                    
                    // 处理网络错误
                    xhr.onerror = function() {
                        console.error('Network error occurred during API request');
                        
                        // 显示错误消息
                        const notification = document.createElement('div');
                        notification.className = 'fixed top-20 right-4 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full';
                        notification.innerText = 'Network error occurred during generation';
                        document.body.appendChild(notification);
                        
                        // 显示通知动画
                        setTimeout(() => {
                            notification.classList.remove('translate-x-full');
                        }, 10);
                        
                        // 3秒后隐藏通知
                        setTimeout(() => {
                            notification.classList.add('translate-x-full');
                            setTimeout(() => {
                                notification.remove();
                            }, 300);
                        }, 3000);
                        
                        // 恢复按钮状态
                        aiGenerateBtn.disabled = false;
                        aiGenerateBtn.innerHTML = '<i class="fa fa-magic mr-2"></i> AI Generating';
                        console.log('AI Generate button state restored after network error');
                    };
                    
                    // 获取设置
                    const settings = loadSettings();
                    
                    // 替换提示词中的参数占位符
                    const replacePromptParameters = function(prompt, wordCount, newWordsPercent, questionCount, optionCount) {
                        // 计算BB参数：100 - 新单词百分比
                        const BB = 100 - newWordsPercent;
                        
                        // 替换AA, BB, CC, DD参数
                        let processedPrompt = prompt
                            .replace(/AA/g, wordCount.toString())
                            .replace(/BB/g, BB.toString())
                            .replace(/CC/g, questionCount.toString())
                            .replace(/DD/g, optionCount.toString());
                        
                        return processedPrompt;
                    };
                    
                    // 处理自定义提示词
                    const wordCount = settings.articleWordCount || 100;
                    const newWordsPercent = settings.newWordsPercentage || 0;
                    const questionCount = settings.numberOfQuestions || 3;
                    const optionCount = settings.numberOfOptions || 3;
                    
                    // 替换提示词中的参数占位符
                    const processedCustomPrompt = settings.customPrompt ? 
                        replacePromptParameters(settings.customPrompt, wordCount, newWordsPercent, questionCount, optionCount) : 
                        '';
                    
                    // 准备请求体
                    const requestBody = JSON.stringify({
                        difficulty: settings.readingDifficulty,
                        customPrompt: processedCustomPrompt,
                        articleWordCount: wordCount,
                        newWordsPercentage: newWordsPercent,
                        numberOfQuestions: questionCount,
                        numberOfOptions: optionCount
                    });
                    
                    // 设置请求头
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    
                    // 发送请求
                    xhr.send(requestBody);
                    console.log('API request sent using XMLHttpRequest with settings:', settings);
                });
            } else {
                console.warn('AI Generate button not found in DOM');
            }
        }
        
        // 页面加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            init();
            initReadingComprehension();
            setupAIGenerating();
            
            // 英文翻译测试相关功能
            // 初始化导入句子按钮事件
            const importSentencesBtn = document.getElementById('import-sentences-btn');
            if (importSentencesBtn) {
                importSentencesBtn.addEventListener('click', handleImportSentences);
            }

            // 初始化开始翻译测试按钮事件
            const startTranslationTestBtn = document.getElementById('start-translation-test-btn');
            if (startTranslationTestBtn) {
                startTranslationTestBtn.addEventListener('click', startTranslationTest);
            }

            // 初始化翻译测试相关按钮事件
            const translationClearBtn = document.getElementById('translation-clear-btn');
            const translationSubmitBtn = document.getElementById('translation-submit-btn');
            const translationNextBtn = document.getElementById('translation-next-btn');
            
            if (translationClearBtn) translationClearBtn.addEventListener('click', clearTranslationSelection);
            if (translationSubmitBtn) translationSubmitBtn.addEventListener('click', submitTranslationAnswer);
            if (translationNextBtn) translationNextBtn.addEventListener('click', nextTranslationQuestion);

            // 存储当前翻译测试状态
            window.translationTestState = {
                currentQuestionIndex: 0,
                totalQuestions: 0,
                testSentences: [],
                userAnswers: [],
                correctAnswers: 0
            };
        });

            // 处理导入句子的逻辑
            function handleImportSentences() {
                const textarea = document.getElementById('sentences-textarea');
                const sentencesText = textarea.value.trim();
                
                if (!sentencesText) {
                    showImportResults('请输入英文语句及对应的中文分词', 'error');
                    return;
                }

                // 解析输入的句子
                const sentences = parseSentences(sentencesText);
                
                if (sentences.length === 0) {
                    showImportResults('未能解析出有效的句子，请检查输入格式', 'error');
                    return;
                }

                // 发送到服务器保存
                saveSentencesToServer(sentences);
            }

            // 解析用户输入的句子
            function parseSentences(text) {
                const sentences = [];
                const lines = text.split('\n');
                
                let currentEnglishSentence = '';
                
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    // 检查是否是英文句子（带或不带编号）
                    if (isEnglishSentence(line)) {
                        // 如果已经有未配对的英文句子，先处理它
                        if (currentEnglishSentence) {
                            // 如果之前的英文句子没有找到对应的中文分词，添加到列表但没有答案
                            sentences.push({
                                sentence: currentEnglishSentence,
                                answers: ''
                            });
                        }
                        // 提取英文句子（去除可能的编号）
                        currentEnglishSentence = extractEnglishSentence(line);
                    } else if (isChineseText(line) && currentEnglishSentence) {
                        // 如果是中文文本且有未配对的英文句子，将它们配对
                        const answers = normalizeChineseAnswers(line);
                        sentences.push({
                            sentence: currentEnglishSentence,
                            answers: answers
                        });
                        currentEnglishSentence = '';
                    }
                });

                // 处理最后一个未配对的英文句子
                if (currentEnglishSentence) {
                    sentences.push({
                        sentence: currentEnglishSentence,
                        answers: ''
                    });
                }

                return sentences;
            }

            // 判断是否是英文句子
            function isEnglishSentence(text) {
                // 带编号的英文句子，如 '1. Hello world'
                if (/^\d+\.\s*[a-zA-Z]/.test(text)) {
                    return true;
                }
                // 不带编号的英文句子，以英文开头
                if (/^[a-zA-Z]/.test(text)) {
                    return true;
                }
                return false;
            }

            // 提取英文句子（去除编号）
            function extractEnglishSentence(text) {
                // 去除编号部分
                const match = text.match(/^(\d+\.\s*)(.*)$/);
                if (match) {
                    return match[2].trim();
                }
                return text.trim();
            }

            // 判断是否是中文文本
            function isChineseText(text) {
                // 检查是否包含中文字符
                return /[\u4e00-\u9fa5]/.test(text);
            }

            // 标准化中文答案（统一使用英文逗号分隔）
            function normalizeChineseAnswers(text) {
                // 将中文逗号、顿号等替换为英文逗号
                text = text.replace(/[，、；；]/g, ',');
                // 去除多余的空格
                text = text.replace(/\s+/g, '');
                // 去除可能的括号或其他符号
                text = text.replace(/[()（）]/g, '');
                return text.trim();
            }

            // 保存句子到服务器
            function saveSentencesToServer(sentences) {
                // 为每个句子单独发送请求
                let successCount = 0;
                let totalCount = sentences.length;
                let promises = [];
                
                sentences.forEach(sentenceObj => {
                    promises.push(
                        fetch('/api/sentences', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(sentenceObj)
                        })
                        .then(response => {
                            if (response.ok) {
                                successCount++;
                            }
                            return response.json();
                        })
                        .catch(error => {
                            console.error('保存句子失败:', error);
                        })
                    );
                });
                
                Promise.all(promises).then(() => {
                    if (successCount > 0) {
                        showImportResults(`成功导入 ${successCount} 条英文句子`, 'success');
                        document.getElementById('sentences-textarea').value = '';
                    } else {
                        showImportResults('导入失败：请检查输入格式或网络连接', 'error');
                    }
                });
            }

            // 显示导入结果
            function showImportResults(message, type) {
                const importResults = document.getElementById('import-results');
                const resultContent = document.getElementById('import-results-content');
                
                if (importResults && resultContent) {
                    const className = type === 'success' ? 'text-green-600 bg-green-50 border-green-200' : 'text-red-600 bg-red-50 border-red-200';
                    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
                    
                    resultContent.innerHTML = `
                        <div class="${className} p-4 rounded-lg border flex items-start">
                            <i class="fa ${icon} text-xl mt-0.5 mr-3"></i>
                            <p>${message}</p>
                        </div>
                    `;
                    
                    importResults.classList.remove('hidden');
                    
                    // 滚动到结果区域
                    importResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            // 开始翻译测试
            function startTranslationTest() {
                const testCountInput = document.getElementById('translation-test-count');
                const testCount = parseInt(testCountInput.value) || 3;
                
                // 隐藏测试设置区域
                document.getElementById('test-settings').classList.add('hidden');
                document.getElementById('reading-comprehension-box').classList.add('hidden');
                document.getElementById('english-translation-box').classList.add('hidden');
                
                // 显示测试视图
                document.getElementById('translation-test-view').classList.remove('hidden');
                
                // 从服务器获取随机句子
                fetchRandomSentences(testCount);
            }

            // 获取随机句子
            function fetchRandomSentences(count) {
                // 先显示加载状态
                document.getElementById('translation-english-sentence').textContent = '正在加载句子...';
                document.getElementById('translation-word-options').innerHTML = '';
                document.getElementById('translation-answer-area').innerHTML = '';
                
                fetch('/api/sentences')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.length > 0) {
                            // 从返回的句子中随机选择count个
                            const shuffled = [...data].sort(() => 0.5 - Math.random());
                            const selectedSentences = shuffled.slice(0, count);
                            
                            // 初始化测试状态
                            window.translationTestState = {
                                currentQuestionIndex: 0,
                                totalQuestions: selectedSentences.length,
                                testSentences: selectedSentences,
                                userAnswers: [],
                                correctAnswers: 0
                            };
                            
                            // 显示第一个问题
                            displayTranslationQuestion(0);
                        } else {
                            // 没有足够的句子
                            const resultContent = document.getElementById('translation-result-content');
                            resultContent.innerHTML = `
                                <i class="fa fa-exclamation-circle text-4xl text-warning mb-4"></i>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">没有可用的句子</h3>
                                <p class="text-gray-600 mb-6">数据库中没有足够的句子用于翻译测试，请先导入句子。</p>
                            `;
                            document.getElementById('translation-result-feedback').classList.remove('hidden');
                            document.getElementById('translation-next-btn').innerText = '返回测试';
                        }
                    })
                    .catch(error => {
                        console.error('获取随机句子失败:', error);
                        const resultContent = document.getElementById('translation-result-content');
                        resultContent.innerHTML = `
                            <i class="fa fa-exclamation-circle text-4xl text-error mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">获取句子失败</h3>
                            <p class="text-gray-600 mb-6">无法连接到服务器，请稍后再试。</p>
                        `;
                        document.getElementById('translation-result-feedback').classList.remove('hidden');
                        document.getElementById('translation-next-btn').innerText = '返回测试';
                    });
            }

            // 显示翻译问题
            function displayTranslationQuestion(index) {
                const state = window.translationTestState;
                const sentence = state.testSentences[index];
                
                // 更新问题计数
                document.getElementById('translation-current-question').textContent = index + 1;
                document.getElementById('translation-total-questions').textContent = state.totalQuestions;
                
                // 显示英文句子
                document.getElementById('translation-english-sentence').textContent = sentence.sentence;
                
                // 清空答案区域
                const answerArea = document.getElementById('translation-answer-area');
                answerArea.innerHTML = '';
                
                // 构建词语选项（包括正确答案和干扰项）
                buildTranslationWordOptions(sentence);
                
                // 隐藏结果反馈
                document.getElementById('translation-result-feedback').classList.add('hidden');
            }

            // 构建词语选项
            function buildTranslationWordOptions(sentence) {
                const wordOptionsContainer = document.getElementById('translation-word-options');
                wordOptionsContainer.innerHTML = '';
                
                // 解析正确答案的分词
                const correctWords = sentence.answers.split(',').map(word => word.trim()).filter(word => word);
                
                // 如果没有正确答案，直接返回
                if (correctWords.length === 0) {
                    wordOptionsContainer.innerHTML = '<p class="text-gray-500">没有可用的翻译选项</p>';
                    return;
                }
                
                // 生成一些常见的中文干扰词（不再依赖API）
                const commonDistractors = [
                    '的', '是', '在', '有', '和', '我', '他', '你', '了', '就',
                    '人', '一', '这', '那', '上', '下', '来', '去', '到', '说',
                    '要', '看', '好', '不', '能', '会', '可', '对', '也', '但',
                    '而', '之', '以', '于', '由', '为', '从', '与', '及', '比'
                ];
                
                // 合并正确答案和干扰项，并打乱顺序
                const allOptions = [...correctWords, ...commonDistractors].slice(0, 12); // 最多12个选项
                
                // 随机排序选项
                for (let i = allOptions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
                }
                
                // 创建选项按钮
                allOptions.forEach(word => {
                    const button = document.createElement('button');
                    button.className = 'px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition-custom text-sm';
                    button.textContent = word;
                    button.addEventListener('click', () => {
                        addToTranslationAnswer(word, button);
                    });
                    wordOptionsContainer.appendChild(button);
                });
            }

            // 添加词语到答案区域
            function addToTranslationAnswer(word, button) {
                const answerArea = document.getElementById('translation-answer-area');
                
                // 创建答案词语元素
                const answerWord = document.createElement('span');
                answerWord.className = 'px-3 py-1 bg-primary/10 text-primary rounded-lg flex items-center';
                answerWord.innerHTML = `
                    ${word}
                    <button class="ml-1 text-primary/70 hover:text-primary" type="button">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                
                // 添加移除事件
                const removeBtn = answerWord.querySelector('button');
                removeBtn.addEventListener('click', () => {
                    answerArea.removeChild(answerWord);
                    button.disabled = false;
                    button.classList.remove('opacity-50');
                });
                
                // 禁用选项按钮
                button.disabled = true;
                button.classList.add('opacity-50');
                
                // 添加到答案区域
                answerArea.appendChild(answerWord);
            }

            // 清空翻译选择
            function clearTranslationSelection() {
                const answerArea = document.getElementById('translation-answer-area');
                const wordOptions = document.querySelectorAll('#translation-word-options button');
                
                // 清空答案区域
                answerArea.innerHTML = '';
                
                // 重新启用所有选项按钮
                wordOptions.forEach(button => {
                    button.disabled = false;
                    button.classList.remove('opacity-50');
                });
            }

            // 提交翻译答案
            function submitTranslationAnswer() {
                const state = window.translationTestState;
                const currentSentence = state.testSentences[state.currentQuestionIndex];
                
                // 获取用户的答案
                const userAnswerElements = document.querySelectorAll('#translation-answer-area span');
                const userAnswer = Array.from(userAnswerElements).map(el => el.firstChild.textContent.trim());
                
                // 检查答案是否为空
                if (userAnswer.length === 0) {
                    alert('Please select at least one word for your answer.');
                    return;
                }
                
                // 记录用户答案
                state.userAnswers.push({
                    sentenceId: currentSentence.id,
                    sentence: currentSentence.sentence,
                    userAnswer: userAnswer,
                    correctAnswer: currentSentence.answers.split(',').map(word => word.trim()).filter(word => word)
                });
                
                // 检查答案是否正确
                const isCorrect = isTranslationAnswerCorrect(userAnswer, state.userAnswers[state.userAnswers.length - 1].correctAnswer);
                if (isCorrect) {
                    state.correctAnswers++;
                }
                
                // 显示结果反馈
                showTranslationResult(isCorrect, state.userAnswers[state.userAnswers.length - 1]);
            }

            // 检查翻译答案是否正确
            function isTranslationAnswerCorrect(userAnswer, correctAnswer) {
                if (userAnswer.length !== correctAnswer.length) {
                    return false;
                }
                
                // 检查每个位置的词语是否相同
                for (let i = 0; i < userAnswer.length; i++) {
                    if (userAnswer[i] !== correctAnswer[i]) {
                        return false;
                    }
                }
                
                return true;
            }

            // 显示翻译结果
            function showTranslationResult(isCorrect, answerData) {
                const resultContent = document.getElementById('translation-result-content');
                
                if (isCorrect) {
                    // 正确答案
                    resultContent.innerHTML = `
                        <i class="fa fa-check-circle text-4xl text-green-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-green-600 mb-2">Correct!</h3>
                        <p class="text-gray-600 mb-4">Your translation is correct.</p>
                        <div class="bg-green-50 p-4 rounded-lg text-left inline-block">
                            <p class="text-sm text-gray-500 mb-1">Your Answer:</p>
                            <p class="text-gray-800">${answerData.userAnswer.join(' ')}</p>
                        </div>
                    `;
                } else {
                    // 错误答案
                    resultContent.innerHTML = `
                        <i class="fa fa-times-circle text-4xl text-red-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-red-600 mb-2">Incorrect</h3>
                        <p class="text-gray-600 mb-4">Please try again next time.</p>
                        <div class="space-y-3">
                            <div class="bg-red-50 p-4 rounded-lg text-left inline-block">
                                <p class="text-sm text-gray-500 mb-1">Your Answer:</p>
                                <p class="text-gray-800">${answerData.userAnswer.join(' ')}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-left inline-block">
                                <p class="text-sm text-gray-500 mb-1">Correct Answer:</p>
                                <p class="text-gray-800">${answerData.correctAnswer.join(' ')}</p>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('translation-result-feedback').classList.remove('hidden');
            }

            // 下一个翻译问题
            function nextTranslationQuestion() {
                const state = window.translationTestState;
                state.currentQuestionIndex++;
                
                // 检查是否还有更多问题
                if (state.currentQuestionIndex < state.totalQuestions) {
                    // 显示下一个问题
                    displayTranslationQuestion(state.currentQuestionIndex);
                } else {
                    // 显示测试结果
                    showTranslationTestResults();
                }
            }

            // 显示翻译测试结果
            function showTranslationTestResults() {
                const state = window.translationTestState;
                
                // 隐藏测试视图
                document.getElementById('translation-test-view').classList.add('hidden');
                
                // 显示测试结果
                const testResults = document.getElementById('test-results');
                testResults.classList.remove('hidden');
                
                // 计算分数
                const score = Math.round((state.correctAnswers / state.totalQuestions) * 100);
                
                // 更新结果信息
                document.getElementById('test-score').textContent = `${score}%`;
                document.getElementById('result-total').textContent = state.totalQuestions;
                document.getElementById('result-correct').textContent = state.correctAnswers;
                document.getElementById('result-incorrect').textContent = state.totalQuestions - state.correctAnswers;
                
                // 构建详细结果
                const detailedResults = document.getElementById('detailed-results');
                detailedResults.innerHTML = '';
                
                state.userAnswers.forEach((answer, index) => {
                    const isCorrect = isTranslationAnswerCorrect(answer.userAnswer, answer.correctAnswer);
                    const resultItem = document.createElement('div');
                    resultItem.className = `p-4 rounded-lg border ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`;
                    
                    resultItem.innerHTML = `
                        <div class="flex items-start justify-between mb-2">
                            <h4 class="font-medium text-gray-800">Question ${index + 1}</h4>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${isCorrect ? 'Correct' : 'Incorrect'}
                            </span>
                        </div>
                        <p class="text-gray-600 mb-2 text-sm">${answer.sentence}</p>
                        <div class="space-y-1 text-sm">
                            <p class="text-gray-500">Your answer: <span class="text-gray-800">${answer.userAnswer.join(' ')}</span></p>
                            <p class="text-gray-500">Correct answer: <span class="text-gray-800">${answer.correctAnswer.join(' ')}</span></p>
                        </div>
                    `;
                    
                    detailedResults.appendChild(resultItem);
                });
                
                // 启用保存结果按钮
                document.getElementById('save-results-btn').disabled = false;
                
                // 根据是否有错误启用查看错误按钮
                const hasMistakes = state.correctAnswers < state.totalQuestions;
                document.getElementById('review-mistakes-btn').disabled = !hasMistakes;
            }

            // 打乱数组顺序
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            // 句子管理功能 - 全局初始化
            window.selectedSentenceIds = new Set();
            
            // 确保在页面加载完成后初始化
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSentenceManagement);
            } else {
                // 页面已经加载完成，直接初始化
                setTimeout(initSentenceManagement, 100);
            }
            
            // Toast提示功能
            function showToast(message) {
                // 创建toast元素
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg z-50';
                toast.textContent = message;
                
                // 添加到页面
                document.body.appendChild(toast);
                
                // 设置淡入动画
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    toast.style.opacity = '1';
                }, 10);
                
                // 3秒后自动消失
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            // 确认对话框功能
            function confirmAction(message, callback) {
                // 创建遮罩层
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                // 创建对话框
                const dialog = document.createElement('div');
                dialog.className = 'bg-white rounded-lg shadow-xl max-w-md w-full mx-4';
                
                // 设置对话框内容
                dialog.innerHTML = `
                    <div class="p-5">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">确认操作</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="cancel-confirm-btn" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                取消
                            </button>
                            <button id="confirm-btn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                确认
                            </button>
                        </div>
                    </div>
                `;
                
                // 将对话框添加到遮罩层
                overlay.appendChild(dialog);
                
                // 添加到页面
                document.body.appendChild(overlay);
                
                // 绑定取消按钮事件
                dialog.querySelector('#cancel-confirm-btn').addEventListener('click', function() {
                    document.body.removeChild(overlay);
                });
                
                // 绑定确认按钮事件
                dialog.querySelector('#confirm-btn').addEventListener('click', function() {
                    document.body.removeChild(overlay);
                    if (typeof callback === 'function') {
                        callback();
                    }
                });
            }

            // 初始化句子管理模块
            function initSentenceManagement() {
                // 绑定搜索框回车事件
                document.getElementById('search-sentences').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchSentences();
                    }
                });
                
                // 初始化时直接加载句子列表
                loadSentences();

                // 绑定添加句子按钮事件
                document.getElementById('add-sentence-btn').addEventListener('click', function() {
                    showSentenceDialog();
                });

                // 绑定导出句子按钮事件
                document.getElementById('export-sentences-btn').addEventListener('click', function() {
                    exportSentences();
                });

                // 绑定清除所有句子按钮事件
                document.getElementById('clear-sentences-btn').addEventListener('click', function() {
                    confirmAction('确定要清除所有句子吗？此操作不可恢复。', function() {
                        clearAllSentences();
                    });
                });

                // 绑定删除选中句子按钮事件
                document.getElementById('delete-selected-sentences-btn').addEventListener('click', function() {
                    if (window.selectedSentenceIds.size === 0) {
                        showToast('请先选择要删除的句子');
                        return;
                    }
                    confirmAction(`确定要删除选中的 ${window.selectedSentenceIds.size} 个句子吗？此操作不可恢复。`, function() {
                        deleteSelectedSentences();
                    });
                });

                // 绑定关闭句子对话框按钮事件
                document.getElementById('close-sentence-dialog').addEventListener('click', function() {
                    hideSentenceDialog();
                });

                // 绑定保存句子按钮事件
                document.getElementById('save-sentence-btn').addEventListener('click', function() {
                    saveSentence();
                });

                // 加载句子列表
                loadSentences();
            }

            // 加载句子列表
            function loadSentences() {
                const searchTerm = document.getElementById('search-sentences').value.trim();
                const url = searchTerm ? `${API_BASE_URL}/sentences?search=${encodeURIComponent(searchTerm)}` : `${API_BASE_URL}/sentences`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('加载句子失败');
                        }
                        return response.json();
                    })
                    .then(sentences => {
                        const sentenceList = document.getElementById('sentences-list');
                        const noSentencesMessage = document.getElementById('no-sentences-message');

                        // 清空当前列表
                        sentenceList.innerHTML = '';

                        // 重置选中的句子ID集合
                        window.selectedSentenceIds.clear();

                        if (sentences.length === 0) {
                            noSentencesMessage.classList.remove('hidden');
                            document.getElementById('delete-selected-sentences-btn').disabled = true;
                            document.getElementById('export-sentences-btn').disabled = true;
                            document.getElementById('clear-sentences-btn').disabled = true;
                        } else {
                            noSentencesMessage.classList.add('hidden');
                            
                            // 更新统计信息
                            document.getElementById('total-sentences').textContent = sentences.length;
                            document.getElementById('delete-selected-sentences-btn').disabled = window.selectedSentenceIds.size === 0;
                            document.getElementById('export-sentences-btn').disabled = false;
                            document.getElementById('clear-sentences-btn').disabled = false;

                            // 渲染句子列表
                            sentences.forEach(sentence => {
                                const row = document.createElement('tr');
                                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                                row.dataset.id = sentence.id;

                                row.innerHTML = `
                                    <td class="px-4 py-3">
                                        <input type="checkbox" class="sentence-checkbox rounded text-blue-600 focus:ring-blue-500" value="${sentence.id}">
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-800">${sentence.sentence}</td>
                                    <td class="px-4 py-3 text-sm text-gray-800">${sentence.answers}</td>
                                    <td class="px-4 py-3 text-sm text-gray-500">${formatDate(sentence.added_date)}</td>
                                    <td class="px-4 py-3 text-sm">
                                        <div class="flex space-x-2">
                                            <button class="text-blue-600 hover:text-blue-800 edit-sentence-btn" title="编辑">
                                                <i class="fa fa-pencil"></i>
                                            </button>
                                            <button class="text-red-600 hover:text-red-800 delete-sentence-btn" title="删除">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                `;

                                // 绑定复选框事件
                                const checkbox = row.querySelector('.sentence-checkbox');
                                checkbox.addEventListener('change', function() {
                                    updateSelectedSentenceIds();
                                });

                                // 绑定编辑按钮事件
                                const editBtn = row.querySelector('.edit-sentence-btn');
                                editBtn.addEventListener('click', function() {
                                    editSentence(sentence.id);
                                });

                                // 绑定删除按钮事件
                                const deleteBtn = row.querySelector('.delete-sentence-btn');
                                deleteBtn.addEventListener('click', function() {
                                    confirmAction('确定要删除这个句子吗？此操作不可恢复。', function() {
                                        deleteSentence(sentence.id);
                                    });
                                });

                                sentenceList.appendChild(row);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('加载句子错误:', error);
                        showToast('加载句子失败，请检查网络连接或稍后重试');
                        const noSentencesMessage = document.getElementById('no-sentences-message');
                        const sentenceList = document.getElementById('sentences-list');
                        sentenceList.innerHTML = '';
                        noSentencesMessage.classList.remove('hidden');
                    });
            }

            // 搜索句子
            function searchSentences() {
                loadSentences();
            }

            // 更新选中的句子ID集合
            function updateSelectedSentenceIds() {
                const checkboxes = document.querySelectorAll('.sentence-checkbox:checked');
                window.selectedSentenceIds.clear();
                
                checkboxes.forEach(checkbox => {
                    window.selectedSentenceIds.add(parseInt(checkbox.value));
                });
            }

            // 显示句子对话框
            function showSentenceDialog(sentence = null) {
                const dialog = document.getElementById('sentence-dialog');
                const title = document.getElementById('sentence-dialog-title');
                const sentenceIdInput = document.getElementById('sentence-id-input');
                const sentenceInput = document.getElementById('sentence-input');
                const answersInput = document.getElementById('answers-input');

                // 清空表单
                sentenceIdInput.value = '';
                sentenceInput.value = '';
                answersInput.value = '';

                // 设置标题和隐藏ID
                if (sentence) {
                    title.textContent = '编辑句子';
                    sentenceIdInput.value = sentence.id;
                    sentenceInput.value = sentence.sentence;
                    answersInput.value = sentence.answers;
                } else {
                    title.textContent = '添加句子';
                }

                // 显示对话框
                dialog.classList.remove('hidden');
                sentenceInput.focus();
            }

            // 隐藏句子对话框
            function hideSentenceDialog() {
                document.getElementById('sentence-dialog').classList.add('hidden');
            }

            // 保存句子
            function saveSentence() {
                const sentenceId = document.getElementById('sentence-id-input').value;
                const sentence = document.getElementById('sentence-input').value.trim();
                const answers = document.getElementById('answers-input').value.trim();

                // 验证输入
                if (!sentence) {
                    showToast('请输入英文句子');
                    return;
                }

                if (!answers) {
                    showToast('请输入中文答案');
                    return;
                }

                const data = {
                    sentence,
                    answers
                };

                const url = sentenceId ? `${API_BASE_URL}/sentences/${sentenceId}` : `${API_BASE_URL}/sentences`;
                const method = sentenceId ? 'PUT' : 'POST';

                fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(sentenceId ? '更新句子失败' : '添加句子失败');
                        }
                        return response.json();
                    })
                    .then(() => {
                        hideSentenceDialog();
                        loadSentences();
                        showToast(sentenceId ? '句子更新成功' : '句子添加成功');
                    })
                    .catch(error => {
                        console.error('保存句子错误:', error);
                        showToast(error.message);
                    });
            }

            // 编辑句子
            function editSentence(id) {
                fetch(`${API_BASE_URL}/sentences/${id}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('获取句子详情失败');
                        }
                        return response.json();
                    })
                    .then(sentence => {
                        showSentenceDialog(sentence);
                    })
                    .catch(error => {
                        console.error('编辑句子错误:', error);
                        showToast('加载句子详情失败，请稍后重试');
                    });
            }

            // 删除句子
            function deleteSentence(id) {
                fetch(`${API_BASE_URL}/sentences/${id}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('删除句子失败');
                        }
                        return response.json();
                    })
                    .then(() => {
                        loadSentences();
                        showToast('句子删除成功');
                    })
                    .catch(error => {
                        console.error('删除句子错误:', error);
                        showToast('删除句子失败，请稍后重试');
                    });
            }

            // 删除选中的句子
            function deleteSelectedSentences() {
                if (window.selectedSentenceIds.size === 0) {
                    showToast('请先选择要删除的句子');
                    return;
                }

                fetch(`${API_BASE_URL}/sentences/batch-delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ids: Array.from(window.selectedSentenceIds) })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('批量删除句子失败');
                        }
                        return response.json();
                    })
                    .then(() => {
                        loadSentences();
                        showToast(`已成功删除 ${window.selectedSentenceIds.size} 个句子`);
                    })
                    .catch(error => {
                        console.error('批量删除句子错误:', error);
                        showToast('批量删除句子失败，请稍后重试');
                    });
            }

            // 清空所有句子
            function clearAllSentences() {
                fetch(`${API_BASE_URL}/sentences`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('清空句子失败');
                        }
                        return response.json();
                    })
                    .then(() => {
                        loadSentences();
                        showToast('所有句子已清空');
                    })
                    .catch(error => {
                        console.error('清空句子错误:', error);
                        showToast('清空句子失败，请稍后重试');
                    });
            }

            // 导出句子
            function exportSentences() {
                fetch(`${API_BASE_URL}/api/sentences`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('获取句子数据失败');
                        }
                        return response.json();
                    })
                    .then(sentences => {
                        if (sentences.length === 0) {
                            showToast('没有可导出的句子');
                            return;
                        }

                        // 构建CSV内容
                        let csvContent = '英文句子,中文答案,添加日期\n';
                        sentences.forEach(sentence => {
                            // 转义CSV中的特殊字符
                            const escapedSentence = `"${sentence.sentence.replace(/"/g, '""')}"`;
                            const escapedAnswers = `"${sentence.answers.replace(/"/g, '""')}"`;
                            csvContent += `${escapedSentence},${escapedAnswers},${formatDate(sentence.added_date)}\n`;
                        });

                        // 创建Blob对象
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);

                        // 创建下载链接
                        const link = document.createElement('a');
                        link.setAttribute('href', url);
                        link.setAttribute('download', `sentences_${new Date().toISOString().slice(0, 10)}.csv`);
                        link.style.display = 'none';
                        document.body.appendChild(link);

                        // 触发下载
                        link.click();

                        // 清理
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        showToast('句子导出成功');
                    })
                    .catch(error => {
                        console.error('导出句子错误:', error);
                        showToast('导出句子失败，请稍后重试');
                    });
            }

            // 格式化日期
            function formatDate(dateString) {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
        </script>
        
        <!-- 添加/编辑句子对话框 -->
        <div id="sentence-dialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h3 id="sentence-dialog-title" class="text-xl font-semibold text-gray-800">添加句子</h3>
                    <button id="close-sentence-dialog" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-5">
                    <input type="hidden" id="sentence-id-input" value="">
                    <div class="mb-4">
                        <label for="sentence-input" class="block text-sm font-medium text-gray-700 mb-1">英文句子</label>
                        <textarea id="sentence-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="输入英文句子" rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="answers-input" class="block text-sm font-medium text-gray-700 mb-1">中文答案</label>
                        <textarea id="answers-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="输入中文答案" rows="2"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="cancel-sentence-btn" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            取消
                        </button>
                        <button id="save-sentence-btn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            保存
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>